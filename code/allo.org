#+TITLE: Multilevel Urban Tree Allometric equations
#+AUTHOR: Tedward Erker
#+email: erker@wisc.edu
#+PROPERTY:  header-args:R :cache no :results output :exports both :comments link :session *R:allo* :eval yes
#+startup: indent
#+FILETAGS: work allo
#+HTML_HEAD: <link rel="stylesheet" href="main.css" type="text/css">
* Objective
To create better allometric equations for urban trees

* Caveat
I am not an expert on this, but I think I have a contribution to
make.  I'm using a dataset I did not work to collect and it may have
idiosyncrasies that I may not understand.  I also don't fully understand
the modelling approach used to create the equations, namely the
weighting.

* Why needed
Whoops.  They do have equations by tree type:
Tree types: BDL = broadleaf deciduous large, BDM = broadleaf deciduous
medium, BDS = broadleaf deciduous small, BEL = broadleaf evergreen
large, BEM = broadleaf evergreen medium, BES = broadleaf evergreen
small, CEL = conifer evergreen large, CEM = conifer evergreen medium,
CES = conifer evergreen small, PEL = palm evergreen large, PEM = palm
evergreen medium, PES= palm evergreen small.

http://www.cpp.edu/~sagarver/GEO309/exercises/allometry/Predicting_Diameter_Height_Crown_Width_Leaf_Area_peper.pdf

The urban tree allometry dataset is an incredibly valuable resource
for making better predictions about tree growth in urban environments,
and it is essential for accurate ecosystem service evaluation.
However, there are a number of limitations with the current set of
equations that multilevel modelling can address.

Limitations:
1) Limited number of species in each region.  There are only equations
   for the ten most common urban tree species in each region.  If a
   user wants an equation for a different species, they either need to
   use an equation for that species from a different region, or select
   the equation from the species they think is most similar.

2) Hard boundaries of regions.  There are separate allometric
   equations for 16 distinct climatic regions in the US.  However
   climate varies continuously across space.  Users of the equations
   have to pick which region they are closest to, or consider
   averaging two equations, but the weighting could be difficult to
   determine.

3) Some of the existing equations are based on smaller sample sizes
   than reported.  For example, dbh as a function of age for...  only
   has two observations and so the best fitting equation is a straight
   line, but we know that isn't right.

Solution: Allow for information to be shared across species and across
regions when fitting models.  Include climate variables as predictors
in the model so that the allometric equations vary continuously across
space.

A multilevel model would allow for the partial pooling of information
across species and across cities, so that in the cases where we have
little or even no data, we can still make reasonable predictions.  If
we want to make predictions about red maple in our city where we have
no observations, a multilevel model would allow us to take the red
maple equation from another city and adjust it to fit the climate of
our city.

Improvements:
1) Climate based rather than regions based.  Continuous rather than
   discrete, gradient rather than hard boundaries.
2) Rather than set Apps min and Apps Max, we can relax these hard
   boundaries, but include information about how uncertainty
   increases.  Appsmin and Appsmax significantly truncates predictive
   envelope.
3) Can use an equation form that makes sense to extrapolate with (this
   is probably more realistic and worth the decrease in equation form flexibility).
4) Species can be nested within Genus, Genus within broader type
   (conifer/broadleaf/palm etc).


1) One equation for 10 species in each region.  What about species not
   on the list?  What if I'm interested in the equation for red maple
   in the southeast, but the only equation comes from the northeast
   region?  How should I adjust the equation?
2) What if my location is on the border of two regions?  How should I
   average the equations from each region, espcially if they are of
   two different forms (e.g. cubic and log-log)?
   1) this could allow for easy integration of new cities too, because
      right now equations for each region just come from 1 or 2 cities.


1) Currently urban tree allometric equations are built separately for
   each species and for each region.  So there is a separate equation
   for red maple in the northeast and a separate equation for red
   maple in the midwest. These are hard differences when such hard
   divisions don't exist.  Better models for red maple could probably
   be made if the different regions could be pooled to the extent that
   their climates are similar.
2)


 For practicioners who wish to use

what was the metric used to select from models?  was it r^2?  they
used AIC
shouldn't we select the model form based on expert knowledge about
universal tree growth patterns, rather than a small sample of
observations?  We'd expect to occasionally find with small samples
that a cubic relationship best fits the data.  But this relationship
suffers from lack of basis in what we know about how trees grow and
may give grossly inaccurate predictions if considered outside the
range of the data.


cite:Weiskittel_ForestGrowthAndYieldModeling
note on pg 130: for biomass equations:
"Zianis et al. (2005) found that more than two-thirds of the
 equations they examined were functions of just DBH, and more than 75%
 of the studies that reported a sample size had less than 50
 trees. The use of just DBH assumes that the relationship between DBH
 and height is static, which is often not the case, as noted above."

"The application to other populations of simple model forms fitted to
small datasets can produce large prediction errors (e.g. Wang et al.,
2002a). In addition, development of universal (Pilli et al., 2006) and
generalized (Muukkonen, 2007) static equations ignores significant
species variability and complex relationships, particularly when the
goal is to estimate regional and national biomass (Zianis and
Mancuccini, 2004)."



* What should the structure of the equations be?

1) Theoretically realistic
   1) follow what we know about biology
   2) increase confidence in extrapolation
   3) assymetrical sigmoidal for growth
2) Interpretable and parsimonious
   1) few parameters that correspond as much as possible to an
      interpretable part of growth
3) Can fit in Stan
   1) weibull?  may be built in because it is statistical?
   2)

DBH ~ age

assymetrical




** Height
from cite:Weiskittel_ForestGrowthAndYieldModeling:
For example, a cumulative growth curve of height over age shows three
primary stages: (1) juvenile period where growth is rapid and often
exponential; (2) a long period of maturation where the trend is nearly
linear; and (3) old age, where growth is nearly asymptotic

height ~ dbh - weibull? see pg 116 cite:Weiskittel_ForestGrowthAndYieldModeling

Constraining the model with very low dbh's
In addition to asymptotic behavior, most height-to-diameter equation
forms are also constrained to predict a height of 1.3 or 1.37
(i.e. breast height) when DBH is equal to zero, but this constraint
may cause poorer model performance across the full range of DBH
(Newton and Amponsah, 2007).

Hardwood heights tend to be harder to predict because of the lack of a
true leader and the difficulty of measuring hardwood heights
accurately (e.g. Kitahara et al., 2010).


Why Weibull is a decent option:  pg116 cite:Weiskittel_ForestGrowthAndYieldModeling
#+BEGIN_QUOTE
Significant differences between model forms can exist, however, when
limited data are available. For example, Temesgen and von Gadow (2004)
found that the percentage difference in root mean square error between
the best and worst equation for five commonly used model forms varied
from 5 to 33%. Huang et al. (1992) found in their analysis that the
Chapman–Richards, Weibull, and a modified logistic-type function were
consistently among the best performing models because they were
flexible, able to assume a variety of shapes, and extrapolated well.
#+END_QUOTE


** DBH
cite:Weiskittel_ForestGrowthAndYieldModeling
A diameter growth curve would show much the same trend, except there
is a tendency toward more sustained growth rate as the tree matures
(Hann and Hanus, 2002b). While height increment may nearly cease in
maturity, diameter increment must continue in order to produce the
xylem and phloem needed for tree survival
** sigmoidal forms, see the citations within:
cite:Weiskittel_ForestGrowthAndYieldModeling
Various theoretical sigmoid model forms are used to predict growth in
forestry (Zeide, 1993), but most of them can be generalized with a
single equation form (Garcıa, 2005c). The most common sigmoid model
forms include the Gompertz (1825), Bertalanffy (1949), and Richards
(1959) equations.

Although these theoretical models offer some biological
interpretability (e.g. Zeide, 2004), it is easily shown that
well-formulated empirical sigmoid equations can be just as accurate or
even more accurate for a wide range of data (e.g. Martin and Ek, 1984)



cite:garcia_2005

cite:zeide_2004


** It would be nice to have repeat measures of trees to get diameter increments.  Individual variation can be large and noisy.
** Could the response be multivariate?  For example: height, crown length, leaf area etc are covariate.  Modeling them together could make sense :ATTACH:
:PROPERTIES:
:Attachments: Screenshot%202018-04-26%2008.17.38.png
:ID:       4B81E555-8C81-4BD7-8DA9-0827A9F2FB79
:END:

cite:dietze_e_2008 have a multivariate response
The decision to fit all three-response variables simultaneously using
a full covariance matrix, rather than to fit each variable separately,
acknowledges the fact that response variables are likely related to
each other.

[[file:/Users/erker/projects/allo/data/4B/81E555-8C81-4BD7-8DA9-0827A9F2FB79/Screenshot 2018-04-26 08.17.38.png]]
** cite:mcpherson_simpson_99
see pg 168

they follow frelich 1992
 look at his equation form.
also
** look at weibull

\[
\beta_0 + (1 - exp(\beta_1 * DBH^{\beta_2})
\]


from huang 1992

H = 1.3 + a * (1 - exp(-b*DBH^c)


from wikipedia:
cdf:
\[
1 - e^{-(x/\lambda)^k}
\]


#+begin_src R :exports results :results graphics :file ../figs/weibull_test.png

    dbh <- 1:100

      a <- 31
      b <- .0209
      c <- 1.1973
      y <- 1.3 + a * (1 - exp(-b*dbh^c))

    a <- 100
    b <- .13
    c <- .5
    age <- seq(0,100,.1)
  dbh <- 1.3 + a * (1 - exp(-b * age^c))
    plot(age, dbh)
#+end_src

#+RESULTS:
[[file:../figs/weibull_test.png]]

play with the parameters to understand the flexibility and control.



* Methods

** Data
repeat measures on the same individuals would help much.

I wonder if the UFIA would have this eventually and if I could write
the code to incorporate the data.

*** Species
**** taxonomy
Nesting of taxonomy.

Cultivar < Species < Genus < Functional Type

Functional types:
1) Broad leaf
2) Conifer
3) Palm
4) ...
5) ...
| FunctionalType      |
|---------------------|
| broadleaf deciduous |
| broadleaf evergreen |
| conifer evergreen   |
| palm evergreen      |



|     | SpCode | ScientificName                         | FunctionalType      |                     |
|-----+--------+----------------------------------------+---------------------+---------------------|
|   1 | ACFA   | Acacia farnesiana                      | broadleaf deciduous |                     |
|   2 | ACME   | Acacia melanoxylon                     | broadleaf evergreen |                     |
|   3 | ACSA3  | Acacia salicina                        | broadleaf evergreen |                     |
|   4 | ACMA   | Acer macrophyllum                      | broadleaf deciduous |                     |
|   5 | ACNE   | Acer negundo                           | broadleaf deciduous |                     |
|   6 | ACPA   | Acer palmatum                          | broadleaf deciduous |                     |
|   7 | ACPL   | Acer platanoides                       | broadleaf deciduous |                     |
|   8 | ACRU   | Acer rubrum                            | broadleaf deciduous |                     |
|   9 | ACSA1  | Acer saccharinum                       | broadleaf deciduous |                     |
|  10 | ACSA2  | Acer saccharum                         | broadleaf deciduous |                     |
|  11 | AEHI   | Aesculus hippocastanum                 | broadleaf deciduous |                     |
|  12 | BABL   | Bauhinia x blakeana                    | broadleaf evergreen |                     |
|  13 | BENI   | Betula nigra                           | broadleaf deciduous |                     |
|  14 | BEPE   | Betula pendula                         | broadleaf deciduous |                     |
|  15 | BRPO   | Brachychiton populneum                 | broadleaf evergreen |                     |
|  16 | BUCA   | Butia capitata                         | palm evergreen      |                     |
|  17 | CACI   | Callistemon citrinus                   | broadleaf evergreen |                     |
|  18 | CADE2  | Calocedrus decurrens                   | conifer evergreen   |                     |
|  19 | CAIN4  | Calophyllum inophyllum                 | broadleaf evergreen |                     |
|  20 | CABEF  | Carpinus betulus 'Fastigiata'          | broadleaf deciduous |                     |
|  21 | CAIL   | Carya illinoinensis                    | broadleaf deciduous |                     |
|  22 | CANE33 | Cassia x nealiae                       | broadleaf deciduous |                     |
|  23 | CAEQ   | Casuarina equisetifolia                | broadleaf evergreen |                     |
|  24 | CASP   | Catalpa speciosa                       | broadleaf deciduous |                     |
|  25 | CEDE   | Cedrus deodara                         | conifer evergreen   |                     |
|  26 | CELA   | Celtis laevigata                       | conifer evergreen   | This can't be right |
|  27 | CEOC   | Celtis occidentalis                    | broadleaf deciduous |                     |
|  28 | CESI4  | Celtis sinensis                        | broadleaf deciduous |                     |
|  29 | CESI3  | Ceratonia siliqua                      | broadleaf evergreen |                     |
|  30 | CECA   | Cercis canadensis                      | broadleaf deciduous |                     |
|  31 | CHLI   | Chilopsis linearis                     | broadleaf deciduous |                     |
|  32 | CICA   | Cinnamomum camphora                    | broadleaf evergreen |                     |
|  33 | CISP2  | Citharexylum spinosum                  | broadleaf evergreen |                     |
|  34 | CONU   | Cocos nucifera                         | palm evergreen      |                     |
|  35 | COERA2 | Conocarpus erectus var. argenteus      | broadleaf evergreen |                     |
|  36 | COSU2  | Cordia subcordata                      | broadleaf evergreen |                     |
|  37 | COFL   | Cornus florida                         | broadleaf deciduous |                     |
|  38 | CR     | Crataegus sp.                          | broadleaf deciduous |                     |
|  39 | CRLA   | Crataegus x lavallei                   | broadleaf deciduous |                     |
|  40 | CUAN   | Cupaniopsis anacardioides              | broadleaf evergreen |                     |
|  41 | DERE   | Delonix regia                          | broadleaf deciduous |                     |
|  42 | ELAN   | Elaeagnus angustifolia                 | broadleaf deciduous |                     |
|  43 | ELOR2  | Elaeodendron orientale                 | broadleaf evergreen |                     |
|  44 | ERJA   | Eriobotrya japonica                    | broadleaf evergreen |                     |
|  45 | EUFI81 | Eucalyptus ficifolia                   | broadleaf evergreen |                     |
|  46 | EUGL   | Eucalyptus globulus                    | broadleaf evergreen |                     |
|  47 | EUMI2  | Eucalyptus microtheca                  | broadleaf evergreen |                     |
|  48 | EUSI   | Eucalyptus sideroxylon                 | broadleaf evergreen |                     |
|  49 | FASY   | Fagus sylvatica                        | broadleaf deciduous |                     |
|  50 | FIBE   | Ficus benjamina                        | broadleaf evergreen |                     |
|  51 | FIMI   | Ficus thonningii                       | broadleaf evergreen |                     |
|  52 | FIDE6  | Filicium decipiens                     | broadleaf evergreen |                     |
|  53 | FRAM   | Fraxinus americana                     | broadleaf deciduous |                     |
|  54 | FRAN2  | Fraxinus angustifolia                  | broadleaf deciduous |                     |
|  55 | FRAN_R | Fraxinus angustifolia 'Raywood'        | broadleaf deciduous |                     |
|  56 | FREX_H | Fraxinus excelsior 'Hessei'            | broadleaf deciduous |                     |
|  57 | FRHO   | Fraxinus holotricha                    | broadleaf deciduous |                     |
|  58 | FRLA   | Fraxinus latifolia                     | broadleaf deciduous |                     |
|  59 | FRPE   | Fraxinus pennsylvanica                 | broadleaf deciduous |                     |
|  60 | FRPE_M | Fraxinus pennsylvanica 'Marshall'      | broadleaf deciduous |                     |
|  61 | FRUH   | Fraxinus uhdei                         | broadleaf deciduous |                     |
|  62 | FRVE   | Fraxinus velutina                      | broadleaf deciduous |                     |
|  63 | FRVE_G | Fraxinus velutina 'Modesto'            | broadleaf deciduous |                     |
|  64 | GIBI   | Ginkgo biloba                          | broadleaf deciduous |                     |
|  65 | GLTR   | Gleditsia triacanthos                  | broadleaf deciduous |                     |
|  66 | GYDI   | Gymnocladus dioicus                    | broadleaf deciduous |                     |
|  67 | ILOP   | Ilex opaca                             | broadleaf evergreen |                     |
|  68 | ILPA2  | Ilex paraguariensis                    | broadleaf evergreen |                     |
|  69 | JAMI   | Jacaranda mimosifolia                  | broadleaf deciduous |                     |
|  70 | JUNI   | Juglans nigra                          | broadleaf deciduous |                     |
|  71 | JUVI   | Juniperus virginiana                   | conifer evergreen   |                     |
|  72 | JUSI   | Juniperus virginiana var. silicicola   | conifer evergreen   |                     |
|  73 | KOELFO | Koelreuteria elegans                   | broadleaf deciduous |                     |
|  74 | KOPA   | Koelreuteria paniculata                | broadleaf deciduous |                     |
|  75 | LAIN   | Lagerstroemia indica                   | broadleaf deciduous |                     |
|  76 | LA6    | Lagerstroemia sp.                      | broadleaf deciduous |                     |
|  77 | LASP   | Lagerstroemia speciosa                 | broadleaf deciduous |                     |
|  78 | LIST   | Liquidambar styraciflua                | broadleaf deciduous |                     |
|  79 | LITU   | Liriodendron tulipifera                | broadleaf deciduous |                     |
|  80 | MAGR   | Magnolia grandiflora                   | broadleaf evergreen |                     |
|  81 | PYAN   | Malus angustifolia                     | broadleaf deciduous |                     |
|  82 | MA2    | Malus sp.                              | broadleaf deciduous |                     |
|  83 | MEQU   | Melaleuca quinquenervia                | broadleaf evergreen |                     |
|  84 | MEEX   | Metrosideros excelsa                   | broadleaf evergreen |                     |
|  85 | MOAL   | Morus alba                             | broadleaf deciduous |                     |
|  86 | MO     | Morus sp.                              | broadleaf deciduous |                     |
|  87 | OLEU   | Olea europaea                          | broadleaf evergreen |                     |
|  88 | PAAC   | Parkinsonia aculeata                   | broadleaf deciduous |                     |
|  89 | CEFL   | Parkinsonia florida                    | broadleaf deciduous |                     |
|  90 | PHCA   | Phoenix canariensis                    | palm evergreen      |                     |
|  91 | PHDA4  | Phoenix dactylifera                    | palm evergreen      |                     |
|  92 | PIPU   | Picea pungens                          | conifer evergreen   |                     |
|  93 | PIBR2  | Pinus brutia                           | conifer evergreen   |                     |
|  94 | PICA   | Pinus canariensis                      | conifer evergreen   |                     |
|  95 | PICO   | Pinus contorta                         | conifer evergreen   |                     |
|  96 | PIEC   | Pinus echinata                         | conifer evergreen   |                     |
|  97 | PIED   | Pinus edulis                           | conifer evergreen   |                     |
|  98 | PIEL2  | Pinus eldarica                         | conifer evergreen   |                     |
|  99 | PIEL   | Pinus elliottii                        | conifer evergreen   |                     |
| 100 | PIHA   | Pinus halepensis                       | conifer evergreen   |                     |
| 101 | PINI   | Pinus nigra                            | conifer evergreen   |                     |
| 102 | PIPO   | Pinus ponderosa                        | conifer evergreen   |                     |
| 103 | PIRA   | Pinus radiata                          | conifer evergreen   |                     |
| 104 | PIST   | Pinus strobus                          | conifer evergreen   |                     |
| 105 | PISY   | Pinus sylvestris                       | conifer evergreen   |                     |
| 106 | PITA   | Pinus taeda                            | conifer evergreen   |                     |
| 107 | PITH   | Pinus thunbergiana                     | conifer evergreen   |                     |
| 108 | PICH   | Pistacia chinensis                     | broadleaf deciduous |                     |
| 109 | PIUN   | Pittosporum undulatum                  | broadleaf evergreen |                     |
| 110 | PLOC   | Platanus occidentalis                  | broadleaf deciduous |                     |
| 111 | PLRA   | Platanus racemosa                      | broadleaf deciduous |                     |
| 112 | PLAC   | Platanus x acerifolia                  | broadleaf deciduous |                     |
| 113 | THOR   | Platycladus orientalis                 | conifer evergreen   |                     |
| 114 | POMA   | Podocarpus macrophyllus                | conifer evergreen   |                     |
| 115 | POAN   | Populus angustifolia                   | broadleaf deciduous |                     |
| 116 | POTR2  | Populus balsamifera subsp. trichocarpa | broadleaf deciduous |                     |
| 117 | PODE   | Populus deltoides                      | broadleaf deciduous |                     |
| 118 | POFR   | Populus fremontii                      | broadleaf deciduous |                     |
| 119 | POSA   | Populus sargentii                      | broadleaf deciduous |                     |
| 120 | PRCH   | Prosopis chilensis                     | broadleaf deciduous |                     |
| 121 | PRCA   | Prunus caroliniana                     | broadleaf evergreen |                     |
| 122 | PRCE   | Prunus cerasifera                      | broadleaf deciduous |                     |
| 123 | PRCE   | Prunus cerasifera cvs.                 | broadleaf deciduous |                     |
| 124 | PRSE2  | Prunus serrulata                       | broadleaf deciduous |                     |
| 125 | PR     | Prunus sp.                             | broadleaf deciduous |                     |
| 126 | PRYE   | Prunus yedoensis                       | broadleaf deciduous |                     |
| 127 | PSME   | Pseudotsuga menziesii                  | conifer evergreen   |                     |
| 128 | PYCA   | Pyrus calleryana                       | broadleaf deciduous |                     |
| 129 | PYCA_B | Pyrus calleryana 'Bradford'            | broadleaf deciduous |                     |
| 130 | PYCA   | Pyrus calleryana cvs.                  | broadleaf deciduous |                     |
| 131 | PYKA   | Pyrus kawakamii                        | broadleaf evergreen |                     |
| 132 | PY     | Pyrus sp.                              | broadleaf deciduous |                     |
| 133 | QUAG   | Quercus agrifolia                      | broadleaf evergreen |                     |
| 134 | QUAL   | Quercus alba                           | broadleaf deciduous |                     |
| 135 | QUIL2  | Quercus ilex                           | broadleaf evergreen |                     |
| 136 | QULA2  | Quercus laurifolia                     | broadleaf deciduous |                     |
| 137 | QULO   | Quercus lobata                         | broadleaf deciduous |                     |
| 138 | QUMA1  | Quercus macrocarpa                     | broadleaf deciduous |                     |
| 139 | QUNI   | Quercus nigra                          | broadleaf deciduous |                     |
| 140 | QUPA   | Quercus palustris                      | broadleaf deciduous |                     |
| 141 | QUPH   | Quercus phellos                        | broadleaf deciduous |                     |
| 142 | QURU   | Quercus rubra                          | broadleaf deciduous |                     |
| 143 | QUSH   | Quercus shumardii                      | broadleaf deciduous |                     |
| 144 | QUVI   | Quercus virginiana                     | broadleaf evergreen |                     |
| 145 | RHLA   | Rhus lancea                            | broadleaf evergreen |                     |
| 146 | ROPS   | Robinia pseudoacacia                   | broadleaf deciduous |                     |
| 147 | SAPA   | Sabal palmetto                         | palm evergreen      |                     |
| 148 | PISA2  | Samanea saman                          | broadleaf deciduous |                     |
| 149 | SCMO   | Schinus molle                          | broadleaf evergreen |                     |
| 150 | SCTE   | Schinus terebinthifolius               | broadleaf evergreen |                     |
| 151 | SESE   | Sequoia sempervirens                   | conifer evergreen   |                     |
| 152 | SWMA   | Swietenia mahagoni                     | broadleaf evergreen |                     |
| 153 | SYRO   | Syagrus romanzoffiana                  | palm evergreen      |                     |
| 154 | TAAR   | Tabebuia aurea                         | broadleaf evergreen |                     |
| 155 | TAPA   | Tabebuia heterophylla                  | broadleaf evergreen |                     |
| 156 | TAOC   | Tabebuia ochracea subsp. neochrysantha | broadleaf evergreen |                     |
| 157 | TIAM   | Tilia americana                        | broadleaf deciduous |                     |
| 158 | TICO   | Tilia cordata                          | broadleaf deciduous |                     |
| 159 | TITO   | Tilia tomentosa                        | broadleaf deciduous |                     |
| 160 | TRSE6  | Triadica sebifera                      | broadleaf deciduous |                     |
| 161 | TRCO   | Tristaniopsis conferta                 | broadleaf evergreen |                     |
| 162 | ULAL   | Ulmus alata                            | broadleaf deciduous |                     |
| 163 | ULAM   | Ulmus americana                        | broadleaf deciduous |                     |
| 164 | ULPA   | Ulmus parvifolia                       | broadleaf deciduous |                     |
| 165 | ULPU   | Ulmus pumila                           | broadleaf deciduous |                     |
| 166 | VEME   | Veitchia merrillii                     | palm evergreen      |                     |
| 167 | WAFI   | Washingtonia filifera                  | palm evergreen      |                     |
| 168 | WARO   | Washingtonia robusta                   | palm evergreen      |                     |
| 169 | ZESE   | Zelkova serrata                        | broadleaf deciduous |                     |
**** species traits
think about species level traits - shade tolerance, water use,
morphology (wood, leaf, etc).

where would these come from, what would they be?  What are the traits
that are important for urban environments?



*** Cities and Climate

#+name: city_climate
| Region | City             |  CDD |  HDD | Precip |
|--------+------------------+------+------+--------|
| CenFla | Orlando, FL      | 1806 |  289 |   1367 |
| GulfCo | Charleston, SC   | 1124 | 1221 |   1555 |
| InlEmp | Claremont, CA    |  134 |  872 |    523 |
| InlVal | Modesto, CA      | 1052 | 1439 |    315 |
| SacVal | Sacramento, CA   |  773 | 1718 |    470 |
| InterW | Albuquerque, NM  |  677 | 2416 |    250 |
| LoMidW | Indianapolis, IN |  510 | 3153 |    392 |
| MidWst | Minneapolis, MN  |  355 | 4436 |    622 |
| NMtnPr | Fort Collins, CO |  349 | 3332 |    452 |
| NoCalC | Berkeley, CA     |   39 | 1786 |    564 |
| NoEast | Queens, NY       |  560 | 2819 |   1041 |
| PacfNW | Longview, WA     |  157 | 2468 |   1059 |
| Piedmt | Charlotte, NC    |  847 | 1891 |   1426 |
| SacVal | Santa Monica, CA |  266 |  710 |    570 |
| SWDsrt | Glendale, AZ     | 2128 |  637 |    174 |
| TpIntW | Boise, ID        |  387 | 3325 |    417 |
| Tropic | Honolulu, HI     | 2416 |    0 |   2206 |


*** Tree Dimensions
| Tree Dimension            | abbr |
|---------------------------+------|
| leaf area                 | la   |
| crown diameter            | cd   |
| crown height              | ch   |
| age                       | age  |
| diameter at breast height | dbh  |
| tree height               | th   |

Equations:

| Independent Variable (IV) | Dependent Variable (DV) |
|---------------------------+-------------------------|
| dbh                       | age                     |
| cd                        | dbh                     |
| dbh                       | cd                      |
| dbh                       | ch                      |
| age                       | dbh                     |
| dbh                       | la                      |
| dbh                       | th                      |


** Modelling

IN STAN:
vignette("brms_nonlinear")
http://discourse.mc-stan.org/t/hierarchical-nonlinear-regression/4382/6

DV = f(IV)

model form:
cite:Weiskittel_ForestGrowthAndYieldModeling:
"This reality should lead to model forms that are complex enough to
accurately and adequately characterize the expected major behaviors of
the population, but simple enough to avoid being overly influenced by
the sample’s peculiarities."

see notes on bayesian approach in cite:Weiskittel_ForestGrowthAndYieldModeling

Approach:

Generative

Build up Complexity

heteroscedasticity:
http://discourse.mc-stan.org/t/what-prior-model-formula-should-i-use-to-account-for-heteroscedasticity/4271/2
formula = bf(Y ~ X, sigma ~ X)
example 2: https://arxiv.org/pdf/1705.11123.pdf

advanced brms:
https://journal.r-project.org/archive/2018/RJ-2018-017/index.html

about brms:
cite:buerkner_2017

*** dbh ~ age, pooled
**** generate data

#+begin_src R
b1 <-
b2 <-
b3 <-

#+end_src

#+begin_src R
library(brms)
#+end_src

#+RESULTS:
: Error in library(brms) : there is no package called ‘brms’


* Exploring age and dbh
** load libraries
#+begin_src R :exports none
library(plyr)
library(dplyr)
library(ggplot2)
library(readr)
library(ascii)
library(tidyr)
#+end_src

#+RESULTS:
** functions
#+begin_src R
  options(asciiType = "org")
  ascii.nowarn.print <- function(x,...) {
                                          #op <- options(warn = -1)
                                          #      on.exit(options(op))

      suppressWarnings(print(ascii(x,...)))

  }
#+end_src

#+RESULTS:

** read in data
#+begin_src R :exports code
d <- read_csv("../data/RDS-2016-0005/Data/TS3_Raw_tree_data.csv")
#+end_src

#+RESULTS:
#+begin_example
Parsed with column specification:
cols(
  .default = col_integer(),
  Region = col_character(),
  City = col_character(),
  Source = col_character(),
  Zone = col_character(),
  `Park/Street` = col_character(),
  SpCode = col_character(),
  ScientificName = col_character(),
  CommonName = col_character(),
  TreeType = col_character(),
  street = col_character(),
  `DBH (cm)` = col_double(),
  `TreeHt (m)` = col_double(),
  CrnBase = col_double(),
  `CrnHt (m)` = col_double(),
  `CdiaPar (m)` = col_double(),
  `CDiaPerp (m)` = col_double(),
  `AvgCdia (m)` = col_double(),
  `Leaf (m2)` = col_double(),
  dbh1 = col_double()
)
See spec(...) for full column specifications.
Warning: 24255 parsing failures.
row [90m# A tibble: 5 x 5[39m col     row col   expected   actual file                                            expected   [3m[90m<int>[39m[23m [3m[90m<chr>[39m[23m [3m[90m<chr>[39m[23m      [3m[90m<chr>[39m[23m  [3m[90m<chr>[39m[23m                                           actual [90m1[39m  126[90m2[39m side  an integer C      '../data/RDS-2016-0005/Data/TS3_Raw_tree_data.… file [90m2[39m  126[90m3[39m side  an integer C      '../data/RDS-2016-0005/Data/TS3_Raw_tree_data.… row [90m3[39m  126[90m4[39m side  an integer C      '../data/RDS-2016-0005/Data/TS3_Raw_tree_data.… col [90m4[39m  126[90m5[39m side  an integer C      '../data/RDS-2016-0005/Data/TS3_Raw_tree_data.… expected [90m5[39m  126[90m6[39m side  an integer C      '../data/RDS-2016-0005/Data/TS3_Raw_tree_data.…
... ........................... ... ............................................................................... ........ ............ [... truncated]
Warning message:
In rbind(names(probs), probs_f) :
  number of columns of result is not a multiple of vector length (arg 1)
#+end_example


#+begin_src R
#str(d)
#+end_src

#+RESULTS:
** fix some species things
*** fix lower case species codes
#+begin_src R
d$SpCode <- toupper(d$SpCode)
#+end_src

#+RESULTS:
*** fix QUAG1 to be QUAG
#+begin_src R
d$SpCode[d$SpCode == "QUAG1"] <- "QUAG"
#+end_src

#+RESULTS:
*** fix common names

Not all are fixed!

#+begin_src R
  d$CommonName[d$CommonName == "Kurrajong"] <- "Kurrajong/Bottle tree"
  d$CommonName[d$CommonName == "Bottle tree"] <- "Kurrajong/Bottle tree"

  d$CommonName[d$CommonName == "Apple"] <- "Apple/Crabapple"
  d$CommonName[d$CommonName == "Crabapple"] <- "Apple/Crabapple"


  d$CommonName[d$CommonName == "silver maple"] <- "Silver maple"
  d$CommonName[d$CommonName == "camphor tree"] <- "Camphor tree"
  d$CommonName[d$CommonName == "ginkgo"] <- "Ginkgo"
  d$CommonName[d$CommonName == "honeylocust"] <- "Honeylocust"
  d$CommonName[d$CommonName == "ginkgo"] <- "Ginkgo"
  d$CommonName[d$CommonName == "common crapemyrtle"] <- "Common crapemyrtle"
  d$CommonName[d$CommonName == "sweetgum"] <- "Sweetgum"
  d$CommonName[d$CommonName == "southern magnolia"] <- "Southern magnolia"



#+end_src

#+RESULTS:

** species are
#+name: tree_types
| TreeType | FunctionalType      |
|----------+---------------------|
| BDL      | broadleaf deciduous |
| BDM      | broadleaf deciduous |
| BDS      | broadleaf deciduous |
| BEL      | broadleaf evergreen |
| BEM      | broadleaf evergreen |
| BES      | broadleaf evergreen |
| CEL      | conifer evergreen   |
| CEM      | conifer evergreen   |
| CES      | conifer evergreen   |
| PEL      | palm evergreen      |
| PEM      | palm evergreen      |
| PES      | palm evergreen      |
I got rid of the small medium and large distinctions for
simplification here.

#+begin_src R :var tt=tree_types
  sp <- d %>% select(SpCode, ScientificName, TreeType) %>%
    left_join(tt) %>%
    select(-TreeType) %>%
    unique() %>%
    arrange(ScientificName) %>%
    ascii.nowarn.print()
#+end_src

#+RESULTS:
#+begin_example
Joining, by = "TreeType"
|     | SpCode | ScientificName                         | FunctionalType      |
|-----+--------+----------------------------------------+---------------------|
| 1   | ACFA   | Acacia farnesiana                      | broadleaf deciduous |
| 2   | ACME   | Acacia melanoxylon                     | broadleaf evergreen |
| 3   | ACSA3  | Acacia salicina                        | broadleaf evergreen |
| 4   | ACMA   | Acer macrophyllum                      | broadleaf deciduous |
| 5   | ACNE   | Acer negundo                           | broadleaf deciduous |
| 6   | ACPA   | Acer palmatum                          | broadleaf deciduous |
| 7   | ACPL   | Acer platanoides                       | broadleaf deciduous |
| 8   | ACRU   | Acer rubrum                            | broadleaf deciduous |
| 9   | ACSA1  | Acer saccharinum                       | broadleaf deciduous |
| 10  | ACSA2  | Acer saccharum                         | broadleaf deciduous |
| 11  | AEHI   | Aesculus hippocastanum                 | broadleaf deciduous |
| 12  | BABL   | Bauhinia x blakeana                    | broadleaf evergreen |
| 13  | BENI   | Betula nigra                           | broadleaf deciduous |
| 14  | BEPE   | Betula pendula                         | broadleaf deciduous |
| 15  | BRPO   | Brachychiton populneum                 | broadleaf evergreen |
| 16  | BUCA   | Butia capitata                         | palm evergreen      |
| 17  | CACI   | Callistemon citrinus                   | broadleaf evergreen |
| 18  | CADE2  | Calocedrus decurrens                   | conifer evergreen   |
| 19  | CAIN4  | Calophyllum inophyllum                 | broadleaf evergreen |
| 20  | CABEF  | Carpinus betulus 'Fastigiata'          | broadleaf deciduous |
| 21  | CAIL   | Carya illinoinensis                    | broadleaf deciduous |
| 22  | CANE33 | Cassia x nealiae                       | broadleaf deciduous |
| 23  | CAEQ   | Casuarina equisetifolia                | broadleaf evergreen |
| 24  | CASP   | Catalpa speciosa                       | broadleaf deciduous |
| 25  | CEDE   | Cedrus deodara                         | conifer evergreen   |
| 26  | CELA   | Celtis laevigata                       | conifer evergreen   |
| 27  | CEOC   | Celtis occidentalis                    | broadleaf deciduous |
| 28  | CESI4  | Celtis sinensis                        | broadleaf deciduous |
| 29  | CESI3  | Ceratonia siliqua                      | broadleaf evergreen |
| 30  | CECA   | Cercis canadensis                      | broadleaf deciduous |
| 31  | CHLI   | Chilopsis linearis                     | broadleaf deciduous |
| 32  | CICA   | Cinnamomum camphora                    | broadleaf evergreen |
| 33  | CISP2  | Citharexylum spinosum                  | broadleaf evergreen |
| 34  | CONU   | Cocos nucifera                         | palm evergreen      |
| 35  | COERA2 | Conocarpus erectus var. argenteus      | broadleaf evergreen |
| 36  | COSU2  | Cordia subcordata                      | broadleaf evergreen |
| 37  | COFL   | Cornus florida                         | broadleaf deciduous |
| 38  | CR     | Crataegus sp.                          | broadleaf deciduous |
| 39  | CRLA   | Crataegus x lavallei                   | broadleaf deciduous |
| 40  | CUAN   | Cupaniopsis anacardioides              | broadleaf evergreen |
| 41  | DERE   | Delonix regia                          | broadleaf deciduous |
| 42  | ELAN   | Elaeagnus angustifolia                 | broadleaf deciduous |
| 43  | ELOR2  | Elaeodendron orientale                 | broadleaf evergreen |
| 44  | ERJA   | Eriobotrya japonica                    | broadleaf evergreen |
| 45  | EUFI81 | Eucalyptus ficifolia                   | broadleaf evergreen |
| 46  | EUGL   | Eucalyptus globulus                    | broadleaf evergreen |
| 47  | EUMI2  | Eucalyptus microtheca                  | broadleaf evergreen |
| 48  | EUSI   | Eucalyptus sideroxylon                 | broadleaf evergreen |
| 49  | FASY   | Fagus sylvatica                        | broadleaf deciduous |
| 50  | FIBE   | Ficus benjamina                        | broadleaf evergreen |
| 51  | FIMI   | Ficus thonningii                       | broadleaf evergreen |
| 52  | FIDE6  | Filicium decipiens                     | broadleaf evergreen |
| 53  | FRAM   | Fraxinus americana                     | broadleaf deciduous |
| 54  | FRAN2  | Fraxinus angustifolia                  | broadleaf deciduous |
| 55  | FRAN_R | Fraxinus angustifolia 'Raywood'        | broadleaf deciduous |
| 56  | FREX_H | Fraxinus excelsior 'Hessei'            | broadleaf deciduous |
| 57  | FRHO   | Fraxinus holotricha                    | broadleaf deciduous |
| 58  | FRLA   | Fraxinus latifolia                     | broadleaf deciduous |
| 59  | FRPE   | Fraxinus pennsylvanica                 | broadleaf deciduous |
| 60  | FRPE_M | Fraxinus pennsylvanica 'Marshall'      | broadleaf deciduous |
| 61  | FRUH   | Fraxinus uhdei                         | broadleaf deciduous |
| 62  | FRVE   | Fraxinus velutina                      | broadleaf deciduous |
| 63  | FRVE_G | Fraxinus velutina 'Modesto'            | broadleaf deciduous |
| 64  | GIBI   | Ginkgo biloba                          | broadleaf deciduous |
| 65  | GLTR   | Gleditsia triacanthos                  | broadleaf deciduous |
| 66  | GYDI   | Gymnocladus dioicus                    | broadleaf deciduous |
| 67  | ILOP   | Ilex opaca                             | broadleaf evergreen |
| 68  | ILPA2  | Ilex paraguariensis                    | broadleaf evergreen |
| 69  | JAMI   | Jacaranda mimosifolia                  | broadleaf deciduous |
| 70  | JUNI   | Juglans nigra                          | broadleaf deciduous |
| 71  | JUVI   | Juniperus virginiana                   | conifer evergreen   |
| 72  | JUSI   | Juniperus virginiana var. silicicola   | conifer evergreen   |
| 73  | KOELFO | Koelreuteria elegans                   | broadleaf deciduous |
| 74  | KOPA   | Koelreuteria paniculata                | broadleaf deciduous |
| 75  | LAIN   | Lagerstroemia indica                   | broadleaf deciduous |
| 76  | LA6    | Lagerstroemia sp.                      | broadleaf deciduous |
| 77  | LASP   | Lagerstroemia speciosa                 | broadleaf deciduous |
| 78  | LIST   | Liquidambar styraciflua                | broadleaf deciduous |
| 79  | LITU   | Liriodendron tulipifera                | broadleaf deciduous |
| 80  | MAGR   | Magnolia grandiflora                   | broadleaf evergreen |
| 81  | PYAN   | Malus angustifolia                     | broadleaf deciduous |
| 82  | MA2    | Malus sp.                              | broadleaf deciduous |
| 83  | MEQU   | Melaleuca quinquenervia                | broadleaf evergreen |
| 84  | MEEX   | Metrosideros excelsa                   | broadleaf evergreen |
| 85  | MOAL   | Morus alba                             | broadleaf deciduous |
| 86  | MO     | Morus sp.                              | broadleaf deciduous |
| 87  | OLEU   | Olea europaea                          | broadleaf evergreen |
| 88  | PAAC   | Parkinsonia aculeata                   | broadleaf deciduous |
| 89  | CEFL   | Parkinsonia florida                    | broadleaf deciduous |
| 90  | PHCA   | Phoenix canariensis                    | palm evergreen      |
| 91  | PHDA4  | Phoenix dactylifera                    | palm evergreen      |
| 92  | PIPU   | Picea pungens                          | conifer evergreen   |
| 93  | PIBR2  | Pinus brutia                           | conifer evergreen   |
| 94  | PICA   | Pinus canariensis                      | conifer evergreen   |
| 95  | PICO   | Pinus contorta                         | conifer evergreen   |
| 96  | PIEC   | Pinus echinata                         | conifer evergreen   |
| 97  | PIED   | Pinus edulis                           | conifer evergreen   |
| 98  | PIEL2  | Pinus eldarica                         | conifer evergreen   |
| 99  | PIEL   | Pinus elliottii                        | conifer evergreen   |
| 100 | PIHA   | Pinus halepensis                       | conifer evergreen   |
| 101 | PINI   | Pinus nigra                            | conifer evergreen   |
| 102 | PIPO   | Pinus ponderosa                        | conifer evergreen   |
| 103 | PIRA   | Pinus radiata                          | conifer evergreen   |
| 104 | PIST   | Pinus strobus                          | conifer evergreen   |
| 105 | PISY   | Pinus sylvestris                       | conifer evergreen   |
| 106 | PITA   | Pinus taeda                            | conifer evergreen   |
| 107 | PITH   | Pinus thunbergiana                     | conifer evergreen   |
| 108 | PICH   | Pistacia chinensis                     | broadleaf deciduous |
| 109 | PIUN   | Pittosporum undulatum                  | broadleaf evergreen |
| 110 | PLOC   | Platanus occidentalis                  | broadleaf deciduous |
| 111 | PLRA   | Platanus racemosa                      | broadleaf deciduous |
| 112 | PLAC   | Platanus x acerifolia                  | broadleaf deciduous |
| 113 | THOR   | Platycladus orientalis                 | conifer evergreen   |
| 114 | POMA   | Podocarpus macrophyllus                | conifer evergreen   |
| 115 | POAN   | Populus angustifolia                   | broadleaf deciduous |
| 116 | POTR2  | Populus balsamifera subsp. trichocarpa | broadleaf deciduous |
| 117 | PODE   | Populus deltoides                      | broadleaf deciduous |
| 118 | POFR   | Populus fremontii                      | broadleaf deciduous |
| 119 | POSA   | Populus sargentii                      | broadleaf deciduous |
| 120 | PRCH   | Prosopis chilensis                     | broadleaf deciduous |
| 121 | PRCA   | Prunus caroliniana                     | broadleaf evergreen |
| 122 | PRCE   | Prunus cerasifera                      | broadleaf deciduous |
| 123 | PRCE   | Prunus cerasifera cvs.                 | broadleaf deciduous |
| 124 | PRSE2  | Prunus serrulata                       | broadleaf deciduous |
| 125 | PR     | Prunus sp.                             | broadleaf deciduous |
| 126 | PRYE   | Prunus yedoensis                       | broadleaf deciduous |
| 127 | PSME   | Pseudotsuga menziesii                  | conifer evergreen   |
| 128 | PYCA   | Pyrus calleryana                       | broadleaf deciduous |
| 129 | PYCA_B | Pyrus calleryana 'Bradford'            | broadleaf deciduous |
| 130 | PYCA   | Pyrus calleryana cvs.                  | broadleaf deciduous |
| 131 | PYKA   | Pyrus kawakamii                        | broadleaf evergreen |
| 132 | PY     | Pyrus sp.                              | broadleaf deciduous |
| 133 | QUAG   | Quercus agrifolia                      | broadleaf evergreen |
| 134 | QUAL   | Quercus alba                           | broadleaf deciduous |
| 135 | QUIL2  | Quercus ilex                           | broadleaf evergreen |
| 136 | QULA2  | Quercus laurifolia                     | broadleaf deciduous |
| 137 | QULO   | Quercus lobata                         | broadleaf deciduous |
| 138 | QUMA1  | Quercus macrocarpa                     | broadleaf deciduous |
| 139 | QUNI   | Quercus nigra                          | broadleaf deciduous |
| 140 | QUPA   | Quercus palustris                      | broadleaf deciduous |
| 141 | QUPH   | Quercus phellos                        | broadleaf deciduous |
| 142 | QURU   | Quercus rubra                          | broadleaf deciduous |
| 143 | QUSH   | Quercus shumardii                      | broadleaf deciduous |
| 144 | QUVI   | Quercus virginiana                     | broadleaf evergreen |
| 145 | RHLA   | Rhus lancea                            | broadleaf evergreen |
| 146 | ROPS   | Robinia pseudoacacia                   | broadleaf deciduous |
| 147 | SAPA   | Sabal palmetto                         | palm evergreen      |
| 148 | PISA2  | Samanea saman                          | broadleaf deciduous |
| 149 | SCMO   | Schinus molle                          | broadleaf evergreen |
| 150 | SCTE   | Schinus terebinthifolius               | broadleaf evergreen |
| 151 | SESE   | Sequoia sempervirens                   | conifer evergreen   |
| 152 | SWMA   | Swietenia mahagoni                     | broadleaf evergreen |
| 153 | SYRO   | Syagrus romanzoffiana                  | palm evergreen      |
| 154 | TAAR   | Tabebuia aurea                         | broadleaf evergreen |
| 155 | TAPA   | Tabebuia heterophylla                  | broadleaf evergreen |
| 156 | TAOC   | Tabebuia ochracea subsp. neochrysantha | broadleaf evergreen |
| 157 | TIAM   | Tilia americana                        | broadleaf deciduous |
| 158 | TICO   | Tilia cordata                          | broadleaf deciduous |
| 159 | TITO   | Tilia tomentosa                        | broadleaf deciduous |
| 160 | TRSE6  | Triadica sebifera                      | broadleaf deciduous |
| 161 | TRCO   | Tristaniopsis conferta                 | broadleaf evergreen |
| 162 | ULAL   | Ulmus alata                            | broadleaf deciduous |
| 163 | ULAM   | Ulmus americana                        | broadleaf deciduous |
| 164 | ULPA   | Ulmus parvifolia                       | broadleaf deciduous |
| 165 | ULPU   | Ulmus pumila                           | broadleaf deciduous |
| 166 | VEME   | Veitchia merrillii                     | palm evergreen      |
| 167 | WAFI   | Washingtonia filifera                  | palm evergreen      |
| 168 | WARO   | Washingtonia robusta                   | palm evergreen      |
| 169 | ZESE   | Zelkova serrata                        | broadleaf deciduous |
#+end_example
** tidy a few names and select variables of interest here
#+begin_src R
d <- d %>% rename(DBH = `DBH (cm)`, Leaf = `Leaf (m2)`) %>% select(Region, City, TreeID, SpCode, DBH, Leaf, DBH, Age)
#+end_src

#+RESULTS:

#+begin_src R
summary(d$Leaf)
sum(d$Leaf == -1) / length(d$Leaf)
sum(d$DBH == -1) / length(d$DBH)
#+end_src

#+RESULTS:
:    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
:    -1.0    12.9   116.1   302.5   389.2  9516.0
: [1] 0.1143094
: [1] 0

#+begin_src R
  d <- filter(d, DBH != -1, Age != -1) %>%
    rename(AGE = Age)
#+end_src

#+RESULTS:

** plot age versus dbh for all trees
#+begin_src R :exports results :results graphics :file ../figs/ageVdbh_all.png :bg transparent
ggplot(d, aes( x = AGE, y = DBH)) + geom_point()
#+end_src

#+RESULTS:
[[file:../figs/ageVdbh_all.png]]

#+begin_src R :exports results :results graphics :file ../figs/ageVdbh_all.png :bg transparent
fram <- filter(d, SpCode == "FRAM")
ggplot(fram, aes( x = AGE, y = DBH)) + geom_point()
#+end_src

#+RESULTS:
[[file:../figs/ageVdbh_all.png]]

#+begin_src R
  m <- nls(DBH ~ a * (1 - exp(-b * AGE^c)), fram, list(a = 100, b = .1, c = .5))
#+end_src

#+RESULTS:


#+begin_src R :exports results :results graphics :file ../figs/fram_test.png

  fram <- fram %>%
      mutate(pred = predict(m)) %>%
      gather(DBH, value, -Region, -City, -SpCode, -TreeID, -Leaf, -AGE)

  ggplot(fram, aes( x = AGE, y = value, color = DBH)) + geom_point()
#+end_src

#+RESULTS:
[[file:../figs/fram_test.png]]

#+begin_src R :exports results :results graphics :file ../figs/weibull.png
  x <- 1:100
  a <- seq(80,110,10)
  b <- 10^(-1*1:3)
  c <- seq(.5, 1.5, .5)

  d <- expand.grid(x = x,a = a, b = b, c = c)

  w <- function(a,b,c,x) a * (1 - exp(-b * x^c))

  d <- d %>%
      mutate(y = w(a,b,c,x))

  ggplot(d, aes( x = x, y = y, color =  a, group = interaction(a,b,c))) + geom_line() + facet_grid(b~c)

#+end_src

#+RESULTS:
[[file:../figs/weibull.png]]

#+begin_src R :exports results :results graphics :file ../figs/weibull_colorA.png
  x <- 1:100
  a <- seq(60,100,20)
  b <- c(.003,.006,.009)
  c <- seq(1, 1.5, .25)

  d <- expand.grid(x = x,a = a, b = b, c = c)

  w <- function(a,b,c,x) a * (1 - exp(-b * x^c))

  d <- d %>%
      mutate(y = w(a,b,c,x))

  ggplot(d, aes( x = x, y = y, color =  a, group = interaction(a,b,c))) + geom_line() + facet_grid(b~c)

#+end_src

#+RESULTS:
[[file:../figs/weibull_colorA.png]]


#+begin_src R :exports results :results graphics :file ../figs/weibull_colorB.png
  ggplot(d, aes( x = x, y = y, color =  b, group = interaction(a,b,c))) + geom_line() + facet_grid(a~c)
#+end_src

#+RESULTS:
[[file:../figs/weibull_colorB.png]]

#+begin_src R :exports results :results graphics :file ../figs/weibull_colorC.png
  ggplot(d, aes( x = x, y = y, color =  c, group = interaction(a,b,c))) + geom_line() + facet_grid(a~b)
#+end_src

#+RESULTS:
[[file:../figs/weibull_colorC.png]]

#+begin_src R :exports results :results graphics :file ../figs/w2.png
  x <- 1:100
  b <- c(.003,.006,.009)
  c <- seq(1, 1.5, .25)

  d <- expand.grid(x = x,a = a, b = b, c = c)

  w2 <- function(b,c,x) (1 - exp(-b * x^c))

  d <- d %>%
      mutate(y = w2(b,c,x))

  ggplot(d, aes( x = x, y = y, group = interaction(b,c))) + geom_line() + facet_grid(b~c)
#+end_src

#+RESULTS:
[[file:../figs/w2.png]]

#+begin_src R :exports results :results graphics :file ../figs/w3.png
  x <- 1:100
  b <- c(.003,.006,.009)
  c <- seq(1, 1.5, .25)

  d <- expand.grid(x = x,a = a, b = b, c = c)

  w3 <- function(b,c,x) exp(-b * x^c)

  d <- d %>%
      mutate(y = w3(b,c,x))

  ggplot(d, aes( x = x, y = y, group = interaction(b,c))) + geom_line() + facet_grid(b~c)
#+end_src

#+RESULTS:
[[file:../figs/w3.png]]

#+begin_src R :exports results :results graphics :file ../figs/w4.png
  x <- 1:100
  b <- c(.003,.006,.009)
  c <- seq(1, 1.5, .25)

  d <- expand.grid(x = x,a = a, b = b, c = c)

  w4 <- function(b,c,x) -b * x^c

  d <- d %>%
      mutate(y = w4(b,c,x))

  ggplot(d, aes( x = x, y = y, group = interaction(b,c))) + geom_line() + facet_grid(b~c)
#+end_src

#+RESULTS:
[[file:../figs/w4.png]]

#+begin_src R :exports results :results graphics :file ../figs/w5.png
  x <- 1:100
  c <- seq(1, 1.5, .25)
  d <- expand.grid(x = x,a = a, c = c)

  w5 <- function(c,x) x^c

  d <- d %>%
      mutate(y = w5(c,x))

  ggplot(d, aes( x = x, y = y, group = c)) + geom_line() + facet_grid(1~c)
#+end_src

#+RESULTS:
[[file:../figs/w5.png]]

** AGE versus dbh by cities
#+begin_src R :exports results :results graphics :file figs/ageVdbh_byCity_focusCoords.png :height 1000 :width 1000
      ggplot(d, aes( x = AGE, y = DBH, color = SpCode)) + geom_point(alpha = .7, size = .5) +
          facet_wrap(~City) +
          coord_cartesian(xlim = c(0, 70), ylim = c(0,100)) +
          theme_minimal() +
          theme(text = element_text(size = 20),
                legend.position = "none")
#+end_src

#+RESULTS:
[[file:../figs/ageVdbh_byCity_focusCoords.png]]

** AGE versus DBH by species
#+begin_src R :exports results :results graphics :file figs/ageVdbh_bySpecies_focusCoords.png :height 1500 :width 800
      ggplot(d, aes( x = AGE, y = DBH, color = City)) + geom_point(alpha = .2, size = .5) +
          facet_wrap(~SpCode, ncol = 8) +
          theme_minimal() +
          theme(text = element_text(size = 20),
                legend.position = "none")
#+end_src

#+RESULTS:
[[file:../figs/ageVdbh_bySpecies_focusCoords.png]]

Woah, there are lots of species.  Clearly there is some variability in
the relationship between age and dbh across species.

** AGE versus DBH by species for species that are in more than 1 city
Does the relationship between AGE and DBH for a species change
depending on the city where it is?

Is there evidence for a different equation for every species city
combination?  Or can we use one equation for each species, regardless
of city?
#+begin_src R
  sp.w.multiple.cities <- d %>% group_by(City, SpCode) %>% summarize(n = n()) %>% ungroup() %>% group_by(SpCode) %>%
    summarize(n_cities_per_species = n()) %>%
    filter(n_cities_per_species > 1) %>%
    pull(SpCode)

d.sp.w.multiple.cities <- filter(d, SpCode %in% sp.w.multiple.cities)

#+end_src

#+RESULTS:


*** Each panel is a species, Each color is a different city
#+begin_src R :exports results :results graphics :file figs/ageVdbh_bySpecies_focusCoords_multiplecities.png :height 1000 :width 800
  ggplot(d.sp.w.multiple.cities, aes( x = AGE, y = DBH, color = City)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free", ncol = 8) +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none")
#+end_src

#+RESULTS:
[[file:../figs/ageVdbh_bySpecies_focusCoords_multiplecities.png]]
*** Adding Loess trend lines

#+begin_src R :exports results :results graphics :file figs/ageVdbh_bySpecies_focusCoords_multiplecities_trendlines.png :height 1100 :width 800
  ggplot(d.sp.w.multiple.cities, aes( x = AGE, y = DBH, color = City)) +
      geom_point(alpha = .7, size = .8) +
      facet_wrap(~SpCode, scales = "free", ncol = 8) +
    #  coord_cartesian(xlim = c(0, 200), ylim = c(0,40)) +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
    stat_smooth()
#+end_src

#+RESULTS:
[[file:../figs/ageVdbh_bySpecies_focusCoords_multiplecities_trendlines.png]]

ACPL's cities
#+begin_src R
filter(d.sp.w.multiple.cities, SpCode == "ACPL") %>% pull(City) %>% unique
#+end_src

#+RESULTS:
: [1] "Fort Collins, CO" "Minneapolis, MN"  "Queens, NY"       "Boise, ID"
: [5] "Longview, WA"

MOAL's cities
#+begin_src R
filter(d.sp.w.multiple.cities, SpCode == "MOAL") %>% pull(City) %>% unique
#+end_src

#+RESULTS:
: [1] "Glendale, AZ" "Longview, WA"
** Plot Urban Tree Allometric equations on top of data

#+begin_src R
          predict.allo <- function(x, EqName, a, b, c, d, e) {
              if(EqName == "loglogw1") {
                  y = exp(a + b*log(log(x + 1) + c/2))
                  }
              else if(EqName == "loglogw2") {
                y = exp(a + b*log(log(x + 1))+(sqrt(x) * (c/2)))
              }
              else if (EqName == "loglogw3") {
                y = exp(a + b*log(log(x + 1)) + x * c/2)
              }
              else if (EqName == "loglogw4") {
                y = exp(a + b*log(log(x + 1)) + x^2 * c/2)
              }
              else if (EqName == "expow1") {
                  y = exp(a+ b * (x) + (c/2))
              }
              else if (EqName == "lin") {
                      y = a + b * x
                  }
              else if (EqName == "quad") {
                      y = a + b * x + c* x^2
                  }
              else if (EqName == "cub") {
                      y = a+b * x+c *x^2 + d * x^3
                  }
              else if (EqName == "quart") {
                      y = a+b * x+c *x^2 + d * x^3 + e * x^4
                  }
              return(y)
          }

#+end_src

#+RESULTS:


#+begin_src R
        eqn <- read.csv("data/RDS-2016-0005/Data/TS6_Growth_coefficients_fromNatalie.csv", stringsAsFactors = F) %>%
              mutate(a = as.numeric(a))

          eqn <- eqn %>%
              filter(Predicts.component %in% c("dbh"), Independent.variable == "age")

    age_min_max = d %>%
      group_by(Region, SpCode) %>%
      summarize(minAGE = min(AGE, na.rm = T),
                maxAGE = max(AGE, na.rm = T))

    eqn <- left_join(eqn, age_min_max)

    DBH_min_max = d %>%
      group_by(Region, SpCode) %>%
      summarize(minDBH = min(DBH, na.rm = T),
                maxDBH = max(DBH, na.rm = T))

    eqn <- left_join(eqn, DBH_min_max)


                                            # fill in the NAs due to equations existing for species in regions where they weren't sampled.
    eqn$minAGE[is.na(eqn$minAGE)] <- 0
    eqn$maxAGE[is.na(eqn$maxAGE)] <- 100

        newdata <- lapply(1:nrow(eqn), function(i) {
            x <- seq(eqn$minAGE[i], eqn$maxAGE[i],  (eqn$maxAGE[i] - eqn$minAGE[i]) / 20)
            cbind(x, eqn[i,])
            })

      newdata <- bind_rows(newdata)

        predictions <- newdata %>% rowwise %>% mutate(predicted_dbh = predict.allo(x = x, EqName = EqName, a = a, b = b, c = c, d = d, e = e))



  #filter out predictions that are outside range of data and label those in range of appsmin and appsmax
  predictions_apprange <- predictions %>%
      filter(predicted_dbh > Apps.min & predicted_dbh < Apps.max)

  predictions_datarange <- predictions %>%
      filter(predicted_dbh > minDBH & predicted_dbh < maxDBH)

#+end_src

#+RESULTS:
: Joining, by = c("Region", "SpCode")
: Joining, by = c("Region", "SpCode")
: There were 50 or more warnings (use warnings() to see the first 50)



#+begin_src R :exports results :results graphics :file figs/predictions_dbh__byRegion.png

  ggplot(predictions_apprange, aes(x = x, y = predicted_dbh, group = SpCode)) +
      geom_line() +
    facet_wrap(~Region, scales = "free")

#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh__byRegion.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_bySpecies.png :height 1200 :width 1200

  ggplot(predictions_apprange, aes(x = x, y = predicted_dbh, group = Region)) +
      geom_line() +
    facet_wrap(~SpCode, scales = "free")

#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_bySpecies.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_bySpeciesFull_wData.png :height 1200 :width 1200
    predictions_apprange <- predictions_apprange %>% mutate(AGE = x, DBH = predicted_dbh)

  ggplot(d, aes( x = AGE, y = DBH, color = Region)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_apprange, aes(group = Region), size = 1.5)

#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_bySpeciesFull_wData.png]]


#+begin_src R :exports results :results graphics :file figs/predictions_dbh_bySpecies_wData.png :height 1200 :width 1200
    predictions_apprange.sp.w.multiple.cities <- predictions_apprange %>%       filter(SpCode %in% d.sp.w.multiple.cities$SpCode)


  ggplot(d.sp.w.multiple.cities, aes( x = AGE, y = DBH, color = Region)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_apprange.sp.w.multiple.cities, aes(group = Region), size = 1.5)

#+end_src


#+RESULTS:
[[file:../figs/predictions_dbh_bySpecies_wData.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_bySpecies_wData_ACPL.png
    predictions_apprange.acpl <- predictions_apprange %>% mutate(AGE = x, DBH = predicted_dbh) %>%
      filter(SpCode == "ACPL")

    predictions_datarange.acpl <- predictions_datarange %>% mutate(AGE = x, DBH = predicted_dbh) %>%
      filter(SpCode == "ACPL")

  ggplot(filter(d, SpCode == "ACPL"), aes( x = AGE, y = DBH, color = Region)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_datarange.acpl, aes(group = Region), size = 2, linetype = "1111") +
      geom_line(data = predictions_apprange.acpl, aes(group = Region), size = 2)


#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_bySpecies_wData_ACPL.png]]

Funny thing about the Apps range is that for functions that eventually
decrease, they don't properly stop inference.  Look at the pink line
above.  The application range should be given for both the predictor
and the response variable.

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_bySpecies_wData_ACPL_facet.png
    predictions_apprange.acpl <- predictions_apprange %>% mutate(AGE = x, DBH = predicted_dbh) %>%
      filter(SpCode == "ACPL")

    predictions_datarange.acpl <- predictions_datarange %>% mutate(AGE = x, DBH = predicted_dbh) %>%
      filter(SpCode == "ACPL")

  ggplot(filter(d, SpCode == "ACPL"), aes( x = AGE, y = DBH)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_datarange.acpl, aes(group = Region, color = Region), size = 1, linetype = "1111") +
      geom_line(data = predictions_apprange.acpl, aes(group = Region, color = Region), size = 1) +
    facet_wrap(~Region)


#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_bySpecies_wData_ACPL_facet.png]]

We should be able to borrow information from other regions to extend
the applicable range for regions with smaller ranges.

There is an equation for the lower midwest, but no data?

#+begin_src R :results org
ascii.nowarn.print(filter(eqn, SpCode == "ACPL"))
#+end_src

#+RESULTS:
#+BEGIN_SRC org
|   | Region | Scientific.Name  | SpCode | Independent.variable | Predicts.component | Units.of.predicted.components | Model.weight | EqName |     a |    b |     c |     d | e | Apps.min | Apps.max | Sigma |     n | adj.R2 | Data.min..from.raw.data. | Data.max..from.raw.data. |    DF | minAGE | maxAGE | minDBH | maxDBH |
|---+--------+------------------+--------+----------------------+--------------------+-------------------------------+--------------+--------+-------+------+-------+-------+---+----------+----------+-------+-------+--------+--------------------------+--------------------------+-------+--------+--------+--------+--------|
| 1 | LoMidW | Acer platanoides | ACPL   | age                  | dbh                | centimeters                   | 1/age        | cub    |  0.98 | 0.25 |  0.04 | -0.00 |   |     0.98 |   103.07 |  0.48 | 13.00 |   0.98 |                     4.80 |                    98.60 |  9.00 |   0.00 | 100.00 |        |        |
| 2 | MidWst | Acer platanoides | ACPL   | age                  | dbh                | centimeters                   | 1            | cub    | -7.95 | 3.81 | -0.09 |  0.00 |   |     2.66 |    93.26 |  8.92 | 48.00 |   0.97 |                     4.60 |                    77.50 | 44.00 |   2.00 |  44.00 |   4.60 |  77.50 |
| 3 | NMtnPr | Acer platanoides | ACPL   | age                  | dbh                | centimeters                   | 1/age^2      | quad   |  2.84 | 1.32 | -0.00 |       |   |     2.84 |    92.73 |  0.08 | 60.00 |   0.94 |                     2.90 |                   103.10 | 57.00 |   0.00 |  88.00 |   2.90 | 103.10 |
| 4 | NoEast | Acer platanoides | ACPL   | age                  | dbh                | centimeters                   | 1            | lin    |  5.62 | 0.92 |       |       |   |     5.62 |   114.66 | 36.41 | 48.00 |   0.91 |                     2.70 |                   120.70 | 46.00 |   0.00 |  75.00 |   3.80 |  87.10 |
| 5 | PacfNW | Acer platanoides | ACPL   | age                  | dbh                | centimeters                   | 1/age        | cub    | -0.85 | 2.44 | -0.03 |  0.00 |   |     1.56 |   146.78 |  1.40 | 74.00 |   0.98 |                     1.10 |                   129.40 | 70.00 |   1.00 |  81.00 |   1.10 | 129.40 |
| 6 | TpIntW | Acer platanoides | ACPL   | age                  | dbh                | centimeters                   | 1/age        | cub    |  4.42 | 1.08 |  0.01 | -0.00 |   |     4.42 |    79.42 |  0.81 | 62.00 |   0.96 |                     5.30 |                    95.00 | 58.00 |   1.00 | 105.00 |   5.30 |  95.00 |
#+END_SRC

#+begin_src R :results org
ascii.nowarn.print(filter(d, SpCode == "ACPL", Region == "NoEast"))
#+end_src

#+RESULTS:
#+BEGIN_SRC org
|   | Region | City       |    TreeID | SpCode |   DBH |   Leaf |   Age |   AGE |
|---+--------+------------+-----------+--------+-------+--------+-------+-------|
| 1 | NoEast | Queens, NY | 900243.00 | ACPL   |  3.80 |   3.10 |  0.00 |  0.00 |
| 2 | NoEast | Queens, NY |  46681.00 | ACPL   | 87.10 | 445.50 | 75.00 | 75.00 |
#+END_SRC

The reason that the equation for ACPL in the North East is linear is
because there are only two observations.  Yikes.


TIAM TpIntW
#+begin_src R :exports results :results graphics :file figs/predictions_dbh_bySpecies_wData_TIAM.pdf :height 3 :width 5

    theme_set(theme_classic(base_size = 12))
  predictions_apprange.tiam <- predictions_apprange %>% mutate(AGE = x, DBH = predicted_dbh) %>%
      filter(SpCode == "TIAM", Region == "TpIntW")

    predictions_datarange.tiam <- predictions_datarange %>% mutate(AGE = x, DBH = predicted_dbh) %>%
      filter(SpCode == "TIAM", Region == "TpIntW")

  ggplot(filter(d, SpCode == "TIAM", Region == "TpIntW"), aes( x = AGE, y = DBH)) +
      geom_point(alpha = .7, size = 1) +
        theme(text = element_text(size = 20)) +
      geom_line(data = predictions_datarange.tiam, aes(group = Region), size = 1, linetype = "1111") +
      geom_line(data = predictions_apprange.tiam, aes(group = Region), size = 1)


#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_bySpecies_wData_TIAM.pdf]]


#+begin_src R :exports results :results graphics :file figs/quadratic.png :height 1200 :width 1200
  ggplot(predictions_apprange %>% filter(EqName == "quad"), aes(x = AGE, y = DBH)) +
    geom_line() +
    facet_wrap(~interaction(SpCode, Region))
#+end_src

#+RESULTS:
[[file:../figs/quadratic.png]]

TIAM TpIntW

** NEXT modelling

Just do the climate effects now

Subset down to 5 species
#+begin_src R
sp.sub <- c("ACPL", "QURU", "PIST", "CEOC", "FRPE")
ds <- filter(d, SpCode %in% sp.sub)
#+end_src

#+RESULTS:

*** lme4
#+begin_src R
library(lme4)
#+end_src

#+RESULTS:

#+begin_src R
ds <- mutate(ds, logDBH = log(DBH), logAGE = log(AGE + 1), AGE2 = AGE^2, AGE2scaled = AGE2/100)
#mod <- lmer(DBH ~ AGE + (1 + AGE | SpCode) + ( 1 + AGE | Region), data = ds)
#mod <- lmer(DBH ~ poly(AGE,2) + (1 + poly(AGE,2) | SpCode) + ( 1 + poly(AGE,2) | Region), data = ds)
#mod <- lmer(DBH ~ poly(AGE,2) + (1 + poly(AGE,2) | SpCode) + ( 1 + AGE | Region), data = ds)
#mod <- lmer(DBH ~ sqrt(AGE) + (1 + sqrt(AGE) | SpCode) + ( 1 + sqrt(AGE) | Region), data = ds)
#mod <- lmer(DBH ~ AGE + (1 + AGE | SpCode) + ( 1 + AGE | Region), data = ds)


#no intercept.  This is a good looking model.
mod <- lmer(DBH ~ AGE + AGE2scaled - 1 + (AGE + AGE2scaled - 1 | SpCode) + (AGE - 1 | Region), data = ds)

#+end_src

#+RESULTS:

#+begin_src R
summary(mod)
#+end_src

#+RESULTS:
#+begin_example
Linear mixed model fit by REML ['lmerMod']
Formula:
DBH ~ AGE + AGE2scaled - 1 + (AGE + -1 | SpCode) + (AGE + AGE2scaled -
    1 | Region)
   Data: ds

REML criterion at convergence: 6096.9

Scaled residuals:
    Min      1Q  Median      3Q     Max
-3.4742 -0.5288 -0.0049  0.5247  3.8558

Random effects:
 Groups   Name       Variance Std.Dev. Corr
 Region   AGE         0.16326 0.40406
          AGE2scaled  0.08519 0.29187  -0.93
 SpCode   AGE         0.00158 0.03975
 Residual            91.47154 9.56408
Number of obs: 822, groups:  Region, 8; SpCode, 4

Fixed effects:
           Estimate Std. Error t value
AGE          1.8479     0.1511  12.233
AGE2scaled  -0.8656     0.1199  -7.221

Correlation of Fixed Effects:
           AGE
AGE2scaled -0.895
#+end_example

#+begin_src R

    dsAGE_min_max = ds %>%
      group_by(Region, SpCode) %>%
      summarize(minAGE = min(AGE, na.rm = T),
                maxAGE = max(AGE, na.rm = T)) %>%
        data.frame()

  newdata <- lapply(1:nrow(dsAGE_min_max), function(i) {
      x <- seq(dsAGE_min_max$minAGE[i], dsAGE_min_max$maxAGE[i],  (dsAGE_min_max$maxAGE[i] - dsAGE_min_max$minAGE[i]) / 9)
      cbind(dsAGE_min_max[i,], AGE = x)
  })

  newdata <- bind_rows(newdata)

  newdata <- mutate(newdata, logAGE = log(AGE + 1), AGE2scaled = AGE^2/100)

#+end_src

#+RESULTS:
: There were 17 warnings (use warnings() to see them)

#+begin_src R
  pred <- predict(mod, newdata)

  pred <- cbind(newdata, pred) %>%
    mutate(DBH = pred)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_m1.png
  ggplot(pred, aes(x = AGE, y = DBH)) + geom_line() +
    facet_grid(Region~SpCode)
#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_m1.png]]


#+begin_src R

      dsAGE_min_max = ds %>%
        group_by(SpCode) %>%
        summarize(minAGE = min(AGE, na.rm = T),
                  maxAGE = max(AGE, na.rm = T)) %>%
          data.frame()

    newdata <- lapply(1:nrow(dsAGE_min_max), function(i) {
        x <- seq(dsAGE_min_max$minAGE[i], dsAGE_min_max$maxAGE[i],  (dsAGE_min_max$maxAGE[i] - dsAGE_min_max$minAGE[i]) / 9)
        cbind(dsAGE_min_max[i,], AGE = x)
    })

    newdata <- bind_rows(newdata)

  newdata <- mutate(newdata, logAGE = log(AGE + 1), AGE2scaled = AGE^2/100)


  regions <- rep(unique(ds$Region), each = nrow(newdata))

newdata <- do.call("rbind", replicate(length(unique(regions)), newdata, simplify = FALSE))

  newdata$Region <- regions

#+end_src

#+RESULTS:
: Warning messages:
: 1: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded
: 2: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded
: 3: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded
: 4: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded

#+begin_src R
  pred <- predict(mod, newdata)

  pred <- cbind(newdata, pred) %>%
    mutate(DBH = pred)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_m1_RegionsWoSpecies.png
  ggplot(pred, aes(x = AGE, y = DBH)) + geom_line() +
    facet_grid(Region~SpCode)
#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_m1_RegionsWoSpecies.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_m1_RegionsWoSpecies_wData.png :width 600 :height 600
  ggplot(pred, aes(x = AGE, y = DBH)) + geom_line() +
    facet_grid(Region~SpCode) +
geom_point(data = ds, size = .5, alpha = .5)
#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_m1_RegionsWoSpecies_wData.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_m1_RegionsWoSpecies_wData_facetSpCode.png :width 1000 :height 300
  ggplot(pred, aes(x = AGE, y = DBH, color = Region)) + geom_line() +
  facet_wrap(~SpCode, ncol = 5) +
  geom_point(data = ds, size = .5, alpha = .5)
#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_m1_RegionsWoSpecies_wData_facetSpCode.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_dbh_m1_RegionsWoSpecies_wData_facetRegion_ACPL.png :width 420 :height 400
  ggplot(filter(pred, SpCode == "ACPL", Region %in% unique(filter(ds, SpCode == "ACPL")$Region)), aes(x = AGE, y = DBH, color = Region)) + geom_line() +
  geom_point(data = filter(ds, SpCode == "ACPL"), size = .5, alpha = .5)
#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_m1_RegionsWoSpecies_wData_facetRegion_ACPL.png]]


#+begin_src R :exports results :results graphics :file figs/predictions_dbh_m1_RegionsWoSpecies_wData_facetRegion_ACPL_wUTDeqn.png :width 1000 :height 400
    ggplot(filter(pred, SpCode == "ACPL", Region %in% unique(filter(ds, SpCode == "ACPL")$Region)), aes(x = AGE, y = DBH)) +
        geom_line(aes(color = Region)) +
    facet_wrap(~Region, ncol = 3) +
    geom_point(data = filter(ds, SpCode == "ACPL"), size = .5, alpha = .5) +
        geom_line(data = predictions_apprange.acpl, aes(group = Region), color = "black", size = .5)
#+end_src

#+RESULTS:
[[file:../figs/predictions_dbh_m1_RegionsWoSpecies_wData_facetRegion_ACPL_wUTDeqn.png]]


#+begin_src R
filter(d, SpCode == "ACPL") %>% group_by(Region) %>% summarize(n = n())
#+end_src

#+RESULTS:
: # A tibble: 5 x 2
:   Region     n
:    <chr> <int>
: 1 MidWst    48
: 2 NMtnPr    60
: 3 NoEast     2
: 4 PacfNW    74
: 5 TpIntW    62

#+begin_src R :results org :eval no
ascii.nowarn.print(filter(eqn, SpCode == "ACPL"))
#+end_src


| Region | SpCode | Independent.variable | Predicts.component | Model.weight | EqName |     a |    b |     c |     d | Apps.min | Apps.max | Sigma |     n | adj.R2 | Data.min..from.raw.data. | Data.max..from.raw.data. |    DF | minAGE | maxAGE | minDBH | maxDBH |
|--------+--------+----------------------+--------------------+--------------+--------+-------+------+-------+-------+----------+----------+-------+-------+--------+--------------------------+--------------------------+-------+--------+--------+--------+--------|
| LoMidW | ACPL   | age                  | dbh                | 1/age        | cub    |  0.98 | 0.25 |  0.04 | -0.00 |     0.98 |   103.07 |  0.48 | 13.00 |   0.98 |                     4.80 |                    98.60 |  9.00 |   0.00 | 100.00 |        |        |
| MidWst | ACPL   | age                  | dbh                | 1            | cub    | -7.95 | 3.81 | -0.09 |  0.00 |     2.66 |    93.26 |  8.92 | 48.00 |   0.97 |                     4.60 |                    77.50 | 44.00 |   2.00 |  44.00 |   4.60 |  77.50 |
| NMtnPr | ACPL   | age                  | dbh                | 1/age^2      | quad   |  2.84 | 1.32 | -0.00 |       |     2.84 |    92.73 |  0.08 | 60.00 |   0.94 |                     2.90 |                   103.10 | 57.00 |   0.00 |  88.00 |   2.90 | 103.10 |
| NoEast | ACPL   | age                  | dbh                | 1            | lin    |  5.62 | 0.92 |       |       |     5.62 |   114.66 | 36.41 | 48.00 |   0.91 |                     2.70 |                   120.70 | 46.00 |   0.00 |  75.00 |   3.80 |  87.10 |
| PacfNW | ACPL   | age                  | dbh                | 1/age        | cub    | -0.85 | 2.44 | -0.03 |  0.00 |     1.56 |   146.78 |  1.40 | 74.00 |   0.98 |                     1.10 |                   129.40 | 70.00 |   1.00 |  81.00 |   1.10 | 129.40 |
| TpIntW | ACPL   | age                  | dbh                | 1/age        | cub    |  4.42 | 1.08 |  0.01 | -0.00 |     4.42 |    79.42 |  0.81 | 62.00 |   0.96 |                     5.30 |                    95.00 | 58.00 |   1.00 | 105.00 |   5.30 |  95.00 |

There are 5 regions with data for dbh and age of ACPL.  the North east
has two data points.  Even though there are no data for the LoMidW
region, there is an equation for it with a reported n of 13.  Where
does this equation come from?  The n for the north east is reportedly
48, but is really 2.



**** What about adding climate?
#+begin_src R
sp.sub <- c("ACPL", "QURU", "PIST", "CEOC", "FRPE")
ds <- filter(d, SpCode %in% sp.sub)
#+end_src

#+RESULTS:

#+begin_src R
ds <- mutate(ds, logDBH = log(DBH), logAGE = log(AGE + 1), AGE2 = AGE^2, AGE2scaled = AGE2/100)
#+end_src

#+RESULTS:

from table 1 see above

#+begin_src R :var climate=city_climate
str(climate)
#+end_src

#+RESULTS:
: 'data.frame':	17 obs. of  5 variables:
:  $ Region: chr  "CenFla" "GulfCo" "InlEmp" "InlVal" ...
:  $ City  : chr  "Orlando, FL" "Charleston, SC" "Claremont, CA" "Modesto, CA" ...
:  $ CDD   : int  1806 1124 134 1052 773 677 510 355 349 39 ...
:  $ HDD   : int  289 1221 872 1439 1718 2416 3153 4436 3332 1786 ...
:  $ Precip: int  1367 1555 523 315 470 250 392 622 452 564 ...


#+begin_src R :exports results :results graphics :file figs/climatespace.png
ggplot(climate, aes(x = HDD, y = CDD,label = City)) + geom_point(aes(size = Precip)) + geom_text(hjust = .5, nudge_y = 80)
#+end_src

#+RESULTS:
[[file:../figs/climatespace.png]]

Rescale precip, HDD, and CDD by dividing by 100
#+begin_src R
climate <- climate %>% mutate(HDD = HDD/100, CDD = CDD/100, Precip = Precip/100)
ds <- left_join(ds, climate)
#+end_src

#+RESULTS:
: Joining, by = c("Region", "City")


Just precip for now
#+begin_src R
mod_precip <- lmer(DBH ~ AGE + AGE2scaled - 1 + Precip + Precip:AGE +(AGE + AGE2scaled - 1 | SpCode) + (AGE - 1 | Region), data = ds)
#+end_src

#+RESULTS:

#+begin_src R
      dsAGE_min_max = ds %>%
        group_by(SpCode) %>%
        summarize(minAGE = min(AGE, na.rm = T),
                  maxAGE = max(AGE, na.rm = T)) %>%
          data.frame()

  newdata <- lapply(1:nrow(dsAGE_min_max), function(i) {
          x <- seq(dsAGE_min_max$minAGE[i], dsAGE_min_max$maxAGE[i],  (dsAGE_min_max$maxAGE[i] - dsAGE_min_max$minAGE[i]) / 9)
          cbind(dsAGE_min_max[i,], AGE = x)
      })

      newdata <- bind_rows(newdata)

    newdata <- mutate(newdata, logAGE = log(AGE + 1), AGE2scaled = AGE^2/100)

  regions <- rep(c("wet","dry"), each = nrow(newdata))
  newprecip <- rep(c(2.5,14), each = nrow(newdata))

  newdata <- do.call("rbind", replicate(length(unique(regions)), newdata, simplify = FALSE))

  newdata$Region <- regions
  newdata$Precip <- newprecip


#+end_src

#+RESULTS:
: Warning messages:
: 1: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded
: 2: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded
: 3: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded
: 4: In data.frame(..., check.names = FALSE) :
:   row names were found from a short variable and have been discarded

#+begin_src R
  pred <- predict(mod_precip, newdata, allow.new.levels = T)

  pred <- cbind(newdata, pred) %>%
    mutate(DBH = pred)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/precip_pred.png
  ggplot(pred, aes(x = AGE, y = DBH, color = Precip, group = interaction(Region,Precip))) + geom_line() +
    facet_wrap(~SpCode)
#+end_src

#+RESULTS:
[[file:../figs/precip_pred.png]]

#+begin_src R :exports results :results graphics :file figs/precip_pred_wsomedata.png
  ggplot(pred, aes(x = AGE, y = DBH, color = Precip, group = interaction(Region,Precip))) + geom_line() +
    facet_wrap(~SpCode) +
    geom_point(data = ds)
#+end_src

#+RESULTS:
[[file:../figs/precip_pred_wsomedata.png]]


#+begin_src R
  ggplot() +

#+end_src

* constrain -b/2a >= max(x) in quadratic model
#+begin_src R
  acpl = readRDS("data/ACPL.rds") %>%
    select(-Leaf, -AGE, -SpCode, -TreeID) %>%
    mutate(Age2 = Age^2)
#+end_src

#+RESULTS:

** just TpIntW
*** unconstrained
#+begin_src R
  a <- filter(acpl, Region == "TpIntW") %>%
      arrange(Age) %>%
      .[seq(10,60,10),]


#+end_src

#+RESULTS:
: Error in filter(acpl, Region == "TpIntW") %>% arrange(Age) %>% .[seq(10,  :
:   could not find function "%>%"

#+begin_src R
m <- lm(DBH ~ Age + Age2 - 1, data = a)
unconstrained_model <- m
#+end_src

#+RESULTS:

#+begin_src R
  pdf <- data.frame(Age = seq(0,105, 5)) %>%
      mutate(Age2 = Age^2)

pdf$DBH <- predict(m, pdf)

#+end_src

#+RESULTS:


#+begin_src R
    y <- c(15, 34.5, 39.6, 51.6, 91.7, 73.7)
    x <- c(10L, 20L, 25L, 40L, 75L, 100L)

  a <- data.frame(y = y, x = x)

    m <- lm(y ~ x + I(x^2) - 1)

    p <- data.frame(x = seq(0,105, 5))

    p$y <- predict(m, p)
#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/acpl_tpintw_quadfit_nodash.pdf :height 3 :width 3
theme_set(theme_classic(base_size = 16))
ggplot(a, aes(x = x, y = y))  +
geom_point() +
geom_line(data = p) +
ggtitle("unconstrained fit")
#+end_src

#+RESULTS:
[[file:../figs/acpl_tpintw_quadfit_nodash.pdf]]

The predictions decrease at the high end, which cannot be correct.
Trying to constrain the curve so that it cannot decrease within the
range of the data.

\[
DBH = a(Age)^2 + b(Age)


\[
DBH = a(Age)^2 + b(Age)
\]

\[
y = ax^2 + bx + \epsilon
\]

\[
\epsilon \sim N(0,\sigma^2)
\]


\[
2ax + b > 0
\]
*** constrained
https://stats.stackexchange.com/questions/220614/linear-regression-polynomial-slope-constraint-in-r?rq=1
y = ax^2 + bx

The positive part of the curve.
2ax + b > 0
b > 0 also


max(x) > -b/2a


#+begin_src R
maxage <- 105
unconstrained_model <- m
#+end_src

#+RESULTS:

#+begin_src R
  library(limSolve)

  A <- matrix(ncol = 2, c(x, x^2))
  B <- y
  G <- matrix(nrow = 1, ncol = 2, byrow = T, data = c(1,200))
  H <- c(0)

  constrained_model <- lsei(A = A,B = B, G = G, H = H, type = 2)

      my_predict <- function(x,coefficients){
      X <- cbind(x,x^2)
      predictions <- X%*%coefficients
      }

      # compute predictions
      xpred <- seq(0,105,5)
      predictions_constrained <- my_predict(xpred,constrained_model$X)
  df2 <- data.frame(xpred,predictions_constrained)
#+end_src

#+RESULTS:

#+begin_src R :eval no
  zhiwei.coef <- c(1.7, -0.0085)
  predictions_constrained <- my_predict(xpred,zhiwei.coef)
    df2 <- data.frame(xpred, predictions_constrained)
#+end_src

#+RESULTS:

#+begin_src R
(200* constrained_model$X[2]) + constrained_model$X[1]
-constrained_model$X[1] / (2* constrained_model$X[2])
#+end_src

#+RESULTS:
: [1] 0
: [1] 100

#+begin_src R :exports results :results graphics :file figs/constrained_quad.pdf :height 3 :width 3
theme_set(theme_classic(base_size = 12))
  ggplot(a, aes(x = x, y = y))  +
  geom_point() +
  geom_line(data = df2, aes(x = xpred, y = predictions_constrained)) +
ggtitle("constrained")
#+end_src

#+RESULTS:
[[file:../figs/constrained_quad.pdf]]

pcls
#+begin_src R
x <-
#+end_src

https://stats.stackexchange.com/questions/220614/linear-regression-polynomial-slope-constraint-in-r?rq=1
#+begin_src R
  x <- c(0.01041667, 0.30208333, 0.61458333, 0.65625000, 0.83333333)
  y <- c(772, 607, 576, 567, 550)

  unconstrained_model <- lm(y ~ x + I(x^2) +I(x^3))

  df <- data.frame(x,y)
  library(ggplot2)
  (p <- ggplot(data=df,aes(x=x,y=y)) + geom_line()+geom_point()+geom_smooth())


  library(limSolve)
  A <- cbind(rep(1,length(x)),x,x^2,x^3)
  b <- y
  G <- matrix(nrow=3,ncol=4,byrow = TRUE,data = c(0, -1,-2,-3,0,-1,-2,0,0,-1,0,0))
  h <- rep(0,3)
  constrained_model <- lsei(A = A, B = b, G = G, H = h, type=2)


  my_predict <- function(x,coefficients){
  X <- cbind(rep(1,length(x)),x,x^2,x^3)
  predictions <- X%*%coefficients
  }
                                          # compute predictions
  xpred <- seq(0,1,len=100)
  predictions_constrained <- my_predict(xpred,constrained_model$X)
  predictions_unconstrained <-    my_predict(xpred,unconstrained_model$coefficients)
  df2 <- data.frame(xpred,predictions_unconstrained,predictions_constrained)

  # plot results
  p <- ggplot(data = df,aes(x = x, y = y,color = "data")) +
  geom_point() +
  geom_line(data = df2, aes(x = xpred, y = predictions_unconstrained, color = "unconstrained fit")) +
  geom_line(data = df2, aes(x = xpred, y = predictions_constrained, color = "constrained fit"))
  p

#+end_src

#+RESULTS:

*** so question
There are many questions on this site about restricted or constrained regression parameters.
https://stats.stackexchange.com/questions/206058/regularized-linear-regression-with-specific-parameter-constraints-in-r, https://stats.stackexchange.com/questions/61733/linear-regression-with-slope-constraint, https://stats.stackexchange.com/questions/228750/1d-linear-regression-with-inequality-constraint, https://stats.stackexchange.com/questions/32641/is-there-an-r-package-for-constrained-regression-that-has-both-a-formula-and-pre, https://stats.stackexchange.com/questions/172748/sparse-coding-with-constraints-in-the-optimization, https://stats.stackexchange.com/questions/123930/linear-regression-with-an-inequality-constraint, https://math.stackexchange.com/questions/60610/polynomial-fitting-where-polynomial-must-be-monotonically-increasing, and more I'm sure.

I've read these and am trying to fit a quadratic relationship that is constrained to be monotonic increasing over the range of my data:

$$y = ax^2 + bx + \epsilon$$   (the $c$ term is zero, $\epsilon$ ~ iid
$N(0,\sigma)$)

To constrain $f(x)$ to be increasing over all values of $x$:
$2ax + b > 0$

Sadly I am not having success implementing this, so this may be more of a "what am I doing wrong question".  My apologies if that's not appropriate here.

Here is the data and the unconstrained fit.  I'm following the approach from this question: https://stats.stackexchange.com/questions/220614/linear-regression-polynomial-slope-constraint-in-r

    y <- c(15, 34.5, 39.6, 51.6, 91.7, 73.7)
    x <- c(10L, 20L, 25L, 40L, 75L, 100L)

    a <- data.frame(y = y, x = x)

    m <- lm(y ~ x + I(x^2) - 1)

    p <- data.frame(x = seq(0,105, 5))

    p$y <- predict(m, p)

    library(ggplot2)
    theme_set(theme_classic(base_size = 24))
    ggplot(a, aes(x = x, y = y))  +
    geom_point() +
    geom_line(data = p)

[![enter image description here][1]][1]

Now trying to fit the curve with inequality constraint.

    library(limSolve)
    A <- matrix(ncol = 2, c(x, x^2))
    B <- y
    G <- matrix(nrow = 1, ncol = 2, byrow = T, data = c(1,2)) # corresponding to 2ax + b
    H <- c(0)

    constrained_model <- lsei(A = A,B = B, G = G, H = H, type = 2)

    my_predict <- function(x,coefficients){
        X <- cbind(x,x^2)
        predictions <- X%*%coefficients
    }

     # compute predictions
     xpred <- seq(0,105,5)
     predictions_constrained <- my_predict(xpred,constrained_model$X)
     df2 <- data.frame(xpred,predictions_constrained)


    ggplot(a, aes(x = x, y = y))  +
      geom_point() +
      geom_line(data = df2, aes(x = xpred, y = predictions_constrained)) +
      ggtitle("constrained fit")

[![enter image description here][2]][2]

As the figure shows, the constraint is having no effect.

Am I not entering the constraint correctly?  Do I have the wrong constraint?

I know there are other packages like mgcv to fit monotonic increasing curves, maybe that would be a better choice?  I'd like to stick with the simple quadratic relationship.

Update: A friend fit this curve in Julia using the same constraints and got a proper curve.  b = 1.7, a = -0.0085.  Here's the curve with those values.  As you can see the function is increasing over the range of x, as desired.
[![proper][3]][3]


  [1]: https://i.stack.imgur.com/IlLJB.png
  [2]: https://i.stack.imgur.com/SBXV0.png
  [3]: https://i.stack.imgur.com/Kq3bK.png

* Exploring dbh and crown diameter
show plots of dbh versus biomass and the published equations on a
figure.

look specifically for places where pooling might help (same species in
two regions)

** load libraries
#+begin_src R :exports none
library(plyr)
library(dplyr)
library(ggplot2)
library(readr)
#+end_src

#+RESULTS:
** read in data
#+begin_src R :exports code
d <- read_csv("data/RDS-2016-0005/Data/TS3_Raw_tree_data.csv")
#+end_src

#+RESULTS:
#+begin_example
Parsed with column specification:
cols(
  .default = col_integer(),
  Region = col_character(),
  City = col_character(),
  Source = col_character(),
  Zone = col_character(),
  `Park/Street` = col_character(),
  SpCode = col_character(),
  ScientificName = col_character(),
  CommonName = col_character(),
  TreeType = col_character(),
  street = col_character(),
  `DBH (cm)` = col_double(),
  `TreeHt (m)` = col_double(),
  CrnBase = col_double(),
  `CrnHt (m)` = col_double(),
  `CdiaPar (m)` = col_double(),
  `CDiaPerp (m)` = col_double(),
  `AvgCdia (m)` = col_double(),
  `Leaf (m2)` = col_double(),
  dbh1 = col_double()
)
See spec(...) for full column specifications.
Warning: 24255 parsing failures.
row # A tibble: 5 x 5 col     row   col   expected actual                                            file expected   <int> <chr>      <chr>  <chr>                                           <chr> actual 1  1262  side an integer      C 'data/RDS-2016-0005/Data/TS3_Raw_tree_data.csv' file 2  1263  side an integer      C 'data/RDS-2016-0005/Data/TS3_Raw_tree_data.csv' row 3  1264  side an integer      C 'data/RDS-2016-0005/Data/TS3_Raw_tree_data.csv' col 4  1265  side an integer      C 'data/RDS-2016-0005/Data/TS3_Raw_tree_data.csv' expected 5  1266  side an integer      C 'data/RDS-2016-0005/Data/TS3_Raw_tree_data.csv'
... ................. ... ............................................................................... ........ ............................................................................... ...... ............................................................................... .... ................................................................. [... truncated]
Warning message:
In rbind(names(probs), probs_f) :
  number of columns of result is not a multiple of vector length (arg 1)
#+end_example


#+begin_src R
#str(d)
#+end_src

#+RESULTS:

** tidy a few names and select variables of interest here
#+begin_src R
d <- d %>% rename(DBH = `DBH (cm)`, Leaf = `Leaf (m2)`, AvgCdia = `AvgCdia (m)`) %>% select(Region, City, TreeID, SpCode, DBH, Leaf, AvgCdia, Age)
#+end_src

#+RESULTS:

#+begin_src R
summary(d$Leaf)
sum(d$Leaf == -1) / length(d$Leaf)
sum(d$AvgCdia == -1) / length(d$AvgCdia)
sum(d$DBH == -1) / length(d$DBH)
#+end_src

#+RESULTS:
:    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
:    -1.0    12.9   116.1   302.5   389.2  9516.0
: [1] 0.1143094
: [1] 0.003244288
: [1] 0

#+begin_src R
d <- filter(d, AvgCdia != -1)
#+end_src

#+RESULTS:

** plot dbh versus average crown diamter for all trees
#+begin_src R :exports results :results graphics :file figs/dbhVcdia_all.png :bg transparent
ggplot(d, aes( x = DBH, y = AvgCdia)) + geom_point()
#+end_src

#+RESULTS:
[[file:../figs/dbhVcdia_all.png]]

** DBH versus Cdia by cities
Constraining scales to 0-200 dbh and 0-40 AvgCdia.  Much of
variability within regions is due to species, colored in the plot below.
#+begin_src R :exports results :results graphics :file figs/dbhVcdia_byCity_focusCoords.png :height 1000 :width 1000
      ggplot(d, aes( x = DBH, y = AvgCdia, color = SpCode)) + geom_point(alpha = .7, size = .5) +
          facet_wrap(~City) +
          coord_cartesian(xlim = c(0, 200), ylim = c(0,40)) +
          theme_minimal() +
          theme(text = element_text(size = 20),
                legend.position = "none")
#+end_src

#+RESULTS:
[[file:../figs/dbhVcdia_byCity_focusCoords.png]]

** DBH versus Cdia by species
#+begin_src R :exports results :results graphics :file figs/dbhVcdia_bySpecies_focusCoords.png :height 1500 :width 800
      ggplot(d, aes( x = DBH, y = AvgCdia, color = City)) + geom_point(alpha = .2, size = .5) +
          facet_wrap(~SpCode, ncol = 8) +
          coord_cartesian(xlim = c(0, 200), ylim = c(0,40)) +
          theme_minimal() +
          theme(text = element_text(size = 20),
                legend.position = "none")
#+end_src

#+RESULTS:
[[file:../figs/dbhVcdia_bySpecies_focusCoords.png]]

Woah, there are lots of species.  Clearly there is some variability in
the relationship between dbh and crown diameter across species.

** DBH versus Cdia by species for species that are in more than 1 city
Does the relationship between DBH and AvgCdia for a species change
depending on the city where it is?

Is there evidence for a different equation for every species city
combination?  Or can we use one equation for each species, regardless
of city?
#+begin_src R
  sp.w.multiple.cities <- d %>% group_by(City, SpCode) %>% summarize(n = n()) %>% ungroup() %>% group_by(SpCode) %>%
    summarize(n_cities_per_species = n()) %>%
    filter(n_cities_per_species > 1) %>%
    pull(SpCode)

d.sp.w.multiple.cities <- filter(d, SpCode %in% sp.w.multiple.cities)

#+end_src

#+RESULTS:


*** Each panel is a species, Each color is a different city
#+begin_src R :exports results :results graphics :file figs/dbhVcdia_bySpecies_focusCoords_multiplecities.png :height 1000 :width 800
  ggplot(d.sp.w.multiple.cities, aes( x = DBH, y = AvgCdia, color = City)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free", ncol = 8) +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none")
#+end_src

#+RESULTS:
[[file:../figs/dbhVcdia_bySpecies_focusCoords_multiplecities.png]]
*** Adding Loess trend lines
It looks like some species have the same relationship (e.g. ACPL),
others may have a different relationship (e.g. LAIN, MOAL), and for
some it is hard to tell because the data don't fully overlap
(e.g. LITU).  This is a very informal assessment, but I think there's
something here.  Similarities are likely due to the cities having
similar climates.  Differences are likely due to cities having
different climates.  There could be a genetic component too.
#+begin_src R :exports results :results graphics :file figs/dbhVcdia_bySpecies_focusCoords_multiplecities_trendlines.png :height 1100 :width 800
  ggplot(d.sp.w.multiple.cities, aes( x = DBH, y = AvgCdia, color = City)) +
      geom_point(alpha = .7, size = .8) +
      facet_wrap(~SpCode, scales = "free", ncol = 8) +
    #  coord_cartesian(xlim = c(0, 200), ylim = c(0,40)) +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
    stat_smooth()
#+end_src

#+RESULTS:
[[file:../figs/dbhVcdia_bySpecies_focusCoords_multiplecities_trendlines.png]]

ACPL's cities
#+begin_src R
filter(d.sp.w.multiple.cities, SpCode == "ACPL") %>% pull(City) %>% unique
#+end_src

#+RESULTS:
: [1] "Fort Collins, CO" "Minneapolis, MN"  "Indianapolis, IN" "Queens, NY"
: [5] "Boise, ID"        "Longview, WA"

MOAL's cities
#+begin_src R
filter(d.sp.w.multiple.cities, SpCode == "MOAL") %>% pull(City) %>% unique
#+end_src

#+RESULTS:
: [1] "Glendale, AZ" "Longview, WA"
** Concluding thoughts
Clearly the relationship between DBH and AvgCdia varies with species
and with location.  However, for many species there is little

** Plot Urban Tree Allometric equations on top of data

#+begin_src R
                predict.allo <- function(x, EqName, a, b, c, d, e) {
              if(EqName == "loglogw1") {
                  y = exp(a + b*log(log(x + 1) + c/2))
                  }
              else if(EqName == "loglogw2") {
                y = exp(a + b*log(log(x + 1))+(sqrt(x) * (c/2)))
              }
              else if (EqName == "loglogw3") {
                y = exp(a + b*log(log(x + 1)) + x * c/2)
              }
              else if (EqName == "loglogw4") {
                y = exp(a + b*log(log(x + 1)) + x^2 * c/2)
              }
              else if (EqName == "expow1") {
                  y = exp(a+ b * (x) + (c/2))
              }
              else if (EqName == "lin") {
                      y = a + b * x
                  }
              else if (EqName == "quad") {
                      y = a + b * x + c* x^2
                  }
              else if (EqName == "cub") {
                      y = a+b * x+c *x^2 + d * x^3
                  }
              else if (EqName == "quart") {
                      y = a+b * x+c *x^2 + d * x^3 + e * x^4
                  }
              return(y)
          }


#+end_src

#+RESULTS:


#+begin_src R
        eqn <- read.csv("data/RDS-2016-0005/Data/TS6_Growth_coefficients_fromNatalie.csv", stringsAsFactors = F) %>%
              mutate(a = as.numeric(a))

          eqn <- eqn %>%
              filter(Predicts.component %in% c("crown dia"), Independent.variable == "dbh")

    dbh_min_max = d %>%
      group_by(Region, SpCode) %>%
      summarize(minDBH = min(DBH, na.rm = T),
                maxDBH = max(DBH, na.rm = T))

    eqn <- left_join(eqn, dbh_min_max)

    cdia_min_max = d %>%
      group_by(Region, SpCode) %>%
      summarize(minCdia = min(AvgCdia, na.rm = T),
                maxCdia = max(AvgCdia, na.rm = T))

    eqn <- left_join(eqn, cdia_min_max)


                                            # fill in the NAs due to equations existing for species in regions where they weren't sampled.
    eqn$minDBH[is.na(eqn$minDBH)] <- 5
    eqn$maxDBH[is.na(eqn$maxDBH)] <- 90

        newdata <- lapply(1:nrow(eqn), function(i) {
            x <- seq(eqn$minDBH[i], eqn$maxDBH[i],  (eqn$maxDBH[i] - eqn$minDBH[i]) / 9)
            cbind(x, eqn[i,])
            })

      newdata <- bind_rows(newdata)

        predictions <- newdata %>% rowwise %>% mutate(predicted_Cdia = predict.allo(x = x, EqName = EqName, a = a, b = b, c = c, d = d, e = e))



  #filter out predictions that are outside range of data and label those in range of appsmin and appsmax
  predictions_apprange <- predictions %>%
      filter(predicted_Cdia > Apps.min & predicted_Cdia < Apps.max)

  predictions_datarange <- predictions %>%
      filter(predicted_Cdia > minCdia & predicted_Cdia < maxCdia)

#+end_src

#+RESULTS:
: Joining, by = c("Region", "SpCode")
: Joining, by = c("Region", "SpCode")
: There were 50 or more warnings (use warnings() to see the first 50)



#+begin_src R :exports results :results graphics :file figs/predictions_byRegion.png

  ggplot(predictions_apprange, aes(x = x, y = predicted_Cdia, group = SpCode)) +
      geom_line() +
    facet_wrap(~Region, scales = "free")

#+end_src

#+RESULTS:
[[file:../figs/predictions_byRegion.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_bySpecies.png :height 1200 :width 1200

  ggplot(predictions_apprange, aes(x = x, y = predicted_Cdia, group = Region)) +
      geom_line() +
    facet_wrap(~SpCode, scales = "free")

#+end_src

#+RESULTS:
[[file:../figs/predictions_bySpecies.png]]

What's up with BUCA and PIPO?  Those equations seem wrong.

#+begin_src R :exports results :results graphics :file figs/GulfCo_BUCA.png
gcbuca <- filter(predictions, Region == "GulfCo", SpCode == "BUCA") %>% mutate(DBH = x)

  ggplot(gcbuca, aes(x = DBH, y = predicted_Cdia)) + geom_line()
#+end_src

#+RESULTS:
[[file:../figs/GulfCo_BUCA.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_bySpeciesFull_wData.png :height 1200 :width 1200
    predictions_apprange <- predictions_apprange %>% mutate(DBH = x, AvgCdia = predicted_Cdia)

  ggplot(d, aes( x = DBH, y = AvgCdia, color = Region)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_apprange, aes(group = Region), size = 1.5)

#+end_src

#+RESULTS:
[[file:../figs/predictions_bySpeciesFull_wData.png]]


#+begin_src R :exports results :results graphics :file figs/predictions_bySpecies_wData.png :height 1200 :width 1200
    predictions_apprange.sp.w.multiple.cities <- predictions_apprange %>%       filter(SpCode %in% d.sp.w.multiple.cities$SpCode)


  ggplot(d.sp.w.multiple.cities, aes( x = DBH, y = AvgCdia, color = Region)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_apprange.sp.w.multiple.cities, aes(group = Region), size = 1.5)

#+end_src


#+RESULTS:
[[file:../figs/predictions_bySpecies_wData.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_bySpecies_wData_ACPL.png
    predictions_apprange.acpl <- predictions_apprange %>% mutate(DBH = x, AvgCdia = predicted_Cdia) %>%
      filter(SpCode == "ACPL")

    predictions_datarange.acpl <- predictions_datarange %>% mutate(DBH = x, AvgCdia = predicted_Cdia) %>%
      filter(SpCode == "ACPL")

  ggplot(filter(d, SpCode == "ACPL"), aes( x = DBH, y = AvgCdia, color = Region)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_datarange.acpl, aes(group = Region), size = 2, linetype = "1111") +
      geom_line(data = predictions_apprange.acpl, aes(group = Region), size = 2)


#+end_src

#+RESULTS:
[[file:../figs/predictions_bySpecies_wData_ACPL.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_bySpecies_wData_ACPL_facet.png
    predictions_apprange.acpl <- predictions_apprange %>% mutate(DBH = x, AvgCdia = predicted_Cdia) %>%
      filter(SpCode == "ACPL")

    predictions_datarange.acpl <- predictions_datarange %>% mutate(DBH = x, AvgCdia = predicted_Cdia) %>%
      filter(SpCode == "ACPL")

  ggplot(filter(d, SpCode == "ACPL"), aes( x = DBH, y = AvgCdia)) +
      geom_point(alpha = .7, size = .5) +
      facet_wrap(~SpCode, scales = "free") +
      theme_minimal() +
      theme(text = element_text(size = 20),
            legend.position = "none") +
      geom_line(data = predictions_datarange.acpl, aes(group = Region, color = Region), size = 1, linetype = "1111") +
      geom_line(data = predictions_apprange.acpl, aes(group = Region, color = Region), size = 1) +
    facet_wrap(~Region)


#+end_src

#+RESULTS:
[[file:../figs/predictions_bySpecies_wData_ACPL_facet.png]]

We should be able to borrow information from other regions to extend
the applicable range for regions with smaller ranges.

** Model
the slope between dbh and the other tree characteristic would be a
function of the species characteristics and the city's climate.


** COMMENT Thinking about writing out the model

This follows Gelman and Hill 2007 notation:

see page 291.

\[
y_i \sim lognormal(\alpha + \beta_{j[i],k[i]} x_i , \sigma_y)
\]

\[
\beta_j \sim normal(\gamma_0 + \gamma_1 u_j, \sigma_\beta)
\]

where
- y is our target tree characteristic, average crown diameter, say.
- x is the diameter at breast height
- u is the "climate" e.g. growing degree days of a city
- \gamma's  are the coefficients for climate on the slope between x
  and y
-
-
  -

** COMMENT climate data
https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/climate-normals/1981-2010-normals-data

see also table 1 in https://www.fs.fed.us/psw/publications/documents/psw_gtr253/psw_gtr_253.pdf

** NEXT modelling

Just do the climate effects now

Subset down to 5 species
#+begin_src R
sp.sub <- c("ACPL", "QURU", "PIST", "CEOC", "FRPE")
ds <- filter(d, SpCode %in% sp.sub)
#+end_src

#+RESULTS:

*** lme4
#+begin_src R
library(lme4)
#+end_src

#+RESULTS:

#+begin_src R
ds <- mutate(ds, logAvgCdia = log(AvgCdia))
mod <- lmer(logAvgCdia ~ log(DBH) + (1 + log(DBH) | SpCode) + ( 1 + log(DBH) | Region), data = ds)
#+end_src

#+RESULTS:

#+begin_src R
mod
#+end_src

#+RESULTS:
#+begin_example
Linear mixed model fit by REML ['lmerMod']
Formula: logAvgCdia ~ log(DBH) | SpCode
   Data: ds
REML criterion at convergence: -439.0436
Random effects:
 Groups   Name        Std.Dev. Corr
 SpCode   (Intercept) 4.5990
          log(DBH)    0.7474   -1.00
 Residual             0.1977
Number of obs: 1224, groups:  SpCode, 5
Fixed Effects:
(Intercept)
      4.168
#+end_example

#+begin_src R

    dsDBH_min_max = ds %>%
      group_by(Region, SpCode) %>%
      summarize(minDBH = min(DBH, na.rm = T),
                maxDBH = max(DBH, na.rm = T)) %>%
        data.frame()

  newdata <- lapply(1:nrow(dsDBH_min_max), function(i) {
      x <- seq(dsDBH_min_max$minDBH[i], dsDBH_min_max$maxDBH[i],  (dsDBH_min_max$maxDBH[i] - dsDBH_min_max$minDBH[i]) / 9)
      cbind(dsDBH_min_max[i,], DBH = x)
  })

  newdata <- bind_rows(newdata)

  newdata <- mutate(newdata, logDBH = log(DBH))

#+end_src

#+begin_src R
  pred <- predict(mod, newdata)

  pred <- cbind(newdata, pred) %>%
    mutate(Cdia = exp(pred))

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/predictions_m1.png
  ggplot(pred, aes(x = DBH, y = Cdia)) + geom_line() +
    facet_grid(Region~SpCode)
#+end_src

#+RESULTS:
[[file:../figs/predictions_m1.png]]


#+begin_src R

      dsDBH_min_max = ds %>%
        group_by(SpCode) %>%
        summarize(minDBH = min(DBH, na.rm = T),
                  maxDBH = max(DBH, na.rm = T)) %>%
          data.frame()

    newdata <- lapply(1:nrow(dsDBH_min_max), function(i) {
        x <- seq(dsDBH_min_max$minDBH[i], dsDBH_min_max$maxDBH[i],  (dsDBH_min_max$maxDBH[i] - dsDBH_min_max$minDBH[i]) / 9)
        cbind(dsDBH_min_max[i,], DBH = x)
    })

    newdata <- bind_rows(newdata)

    newdata <- mutate(newdata, logDBH = log(DBH))


  regions <- rep(unique(ds$Region), each = nrow(newdata))

newdata <- do.call("rbind", replicate(length(unique(regions)), newdata, simplify = FALSE))

  newdata$Region <- regions

#+end_src

#+RESULTS:
#+begin_example
Warning messages:
1: In data.frame(..., check.names = FALSE) :
  row names were found from a short variable and have been discarded
2: In data.frame(..., check.names = FALSE) :
  row names were found from a short variable and have been discarded
3: In data.frame(..., check.names = FALSE) :
  row names were found from a short variable and have been discarded
4: In data.frame(..., check.names = FALSE) :
  row names were found from a short variable and have been discarded
5: In data.frame(..., check.names = FALSE) :
  row names were found from a short variable and have been discarded
#+end_example

#+begin_src R
  pred <- predict(mod, newdata)

  pred <- cbind(newdata, pred) %>%
    mutate(AvgCdia = exp(pred))

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/predictions_m1_RegionsWoSpecies.png
  ggplot(pred, aes(x = DBH, y = AvgCdia)) + geom_line() +
    facet_grid(Region~SpCode)
#+end_src

#+RESULTS:
[[file:../figs/predictions_m1_RegionsWoSpecies.png]]

#+begin_src R :exports results :results graphics :file figs/predictions_m1_RegionsWoSpecies_wData.png :width 600 :height 600
  ggplot(pred, aes(x = DBH, y = AvgCdia)) + geom_line() +
    facet_grid(Region~SpCode) +
geom_point(data = ds, size = .5, alpha = .5)
#+end_src

#+RESULTS:
[[file:../figs/predictions_m1_RegionsWoSpecies_wData.png]]


#+begin_src R :exports results :results graphics :file figs/predictions_m1_RegionsWoSpecies_wData_facetSpCode.png :width 1000 :height 300
  ggplot(pred, aes(x = DBH, y = AvgCdia, color = Region)) + geom_line() +
  facet_wrap(~SpCode, ncol = 5) +
  geom_point(data = ds, size = .5, alpha = .5)
#+end_src

#+RESULTS:
[[file:../figs/predictions_m1_RegionsWoSpecies_wData_facetSpCode.png]]

Obviously, the lines extrapolate quite a bit.  Differences across
regions appear to be pretty small.  Looking at the model summary it is
clear that there is little evidence distinguishing the different
regions and even the different species.  The is much variation not
explained by region or species.

If I used age instead of dbh, I'd probably find stronger differences
across regions.

**** What about adding climate?
from table 1

#+name: city_climate
| Region | City             |  CDD |  HDD | Precip |
|--------+------------------+------+------+--------|
| CenFla | Orlando, FL      | 1806 |  289 |   1367 |
| GulfCo | Charleston, SC   | 1124 | 1221 |   1555 |
| InlEmp | Claremont, CA    |  134 |  872 |    523 |
| InlVal | Modesto, CA      | 1052 | 1439 |    315 |
| SacVal | Sacramento, CA   |  773 | 1718 |    470 |
| InterW | Albuquerque, NM  |  677 | 2416 |    250 |
| LoMidW | Indianapolis, IN |  510 | 3153 |    392 |
| MidWst | Minneapolis, MN  |  355 | 4436 |    622 |
| NMtnPr | Fort Collins, CO |  349 | 3332 |    452 |
| NoCalC | Berkeley, CA     |   39 | 1786 |    564 |
| NoEast | Queens, NY       |  560 | 2819 |   1041 |
| PacfNW | Longview, WA     |  157 | 2468 |   1059 |
| Piedmt | Charlotte, NC    |  847 | 1891 |   1426 |
| SacVal | Santa Monica, CA |  266 |  710 |    570 |
| SWDsrt | Glendale, AZ     | 2128 |  637 |    174 |
| TpIntW | Boise, ID        |  387 | 3325 |    417 |
| Tropic | Honolulu, HI     | 2416 |    0 |   2206 |

These values for CDD and HDD are surprising to me, but maybe I don't
really understand how they are calcuated.  Maybe the theshold
temperature is what's driving it.  I don't think it matters here.

#+begin_src R :var climate=city_climate
str(climate)
#+end_src

#+RESULTS:
: 'data.frame':	17 obs. of  5 variables:
:  $ Region: chr  "CenFla" "GulfCo" "InlEmp" "InlVal" ...
:  $ City  : chr  "Orlando, FL" "Charleston, SC" "Claremont, CA" "Modesto, CA" ...
:  $ CDD   : int  1806 1124 134 1052 773 677 510 355 349 39 ...
:  $ HDD   : int  289 1221 872 1439 1718 2416 3153 4436 3332 1786 ...
:  $ Precip: int  1367 1555 523 315 470 250 392 622 452 564 ...


#+begin_src R :exports results :results graphics :file figs/climatespace.png
ggplot(climate, aes(x = HDD, y = CDD,label = City)) + geom_point(aes(size = Precip)) + geom_text(hjust = .5, nudge_y = 80)
#+end_src

#+RESULTS:
[[file:../figs/climatespace.png]]

Rescale precip, HDD, and CDD by dividing by 100
#+begin_src R
climate <- climate %>% mutate(HDD = HDD/100, CDD = CDD/100, Precip = Precip/100)
ds <- left_join(ds, climate)
#+end_src

#+RESULTS:
: Joining, by = c("Region", "City")


#+begin_src R

#+end_src

Just precip for now
#+begin_src R
mod_precip <- lmer(logAvgCdia ~ log(DBH) + Precip + Precip:log(DBH) + (1 + log(DBH) | SpCode) + ( 1 + log(DBH) | Region), data = ds)
#+end_src

#+RESULTS:

#+begin_src R
mod_hdd <- lmer(logAvgCdia ~ log(DBH) + HDD + HDD:log(DBH) + (1 + log(DBH) | SpCode) + ( 1 + log(DBH) | Region), data = ds)
#+end_src

#+RESULTS:



*** rstanarm
#+begin_src R
library(rstanarm)
options(mc.cores = parallel::detectCores())
#+end_src

#+RESULTS:

#+begin_src R
smod <- stan_glm(log(AvgCdia) ~ DBH, data = d, family = gaussian(link = "identity"))
#+end_src

#+RESULTS:
#+begin_example

SAMPLING FOR MODEL 'continuous' NOW (CHAIN 1).

Gradient evaluation took 0.003692 seconds
1000 transitions using 10 leapfrog steps per transition would take 36.92 seconds.
Adjust your expectations accordingly!


Iteration:    1 / 2000 [  0%]  (Warmup)

SAMPLING FOR MODEL 'continuous' NOW (CHAIN 2).

Gradient evaluation took 0.003201 seconds
1000 transitions using 10 leapfrog steps per transition would take 32.01 seconds.
Adjust your expectations accordingly!


Iteration:    1 / 2000 [  0%]  (Warmup)

SAMPLING FOR MODEL 'continuous' NOW (CHAIN 3).

Gradient evaluation took 0.005202 seconds
1000 transitions using 10 leapfrog steps per transition would take 52.02 seconds.
Adjust your expectations accordingly!


Iteration:    1 / 2000 [  0%]  (Warmup)

SAMPLING FOR MODEL 'continuous' NOW (CHAIN 4).

Gradient evaluation took 0.006159 seconds
1000 transitions using 10 leapfrog steps per transition would take 61.59 seconds.
Adjust your expectations accordingly!


Iteration:    1 / 2000 [  0%]  (Warmup)
Iteration:  200 / 2000 [ 10%]  (Warmup)
Iteration:  200 / 2000 [ 10%]  (Warmup)
Iteration:  200 / 2000 [ 10%]  (Warmup)
Iteration:  200 / 2000 [ 10%]  (Warmup)
Iteration:  400 / 2000 [ 20%]  (Warmup)
Iteration:  400 / 2000 [ 20%]  (Warmup)
Iteration:  400 / 2000 [ 20%]  (Warmup)
Iteration:  400 / 2000 [ 20%]  (Warmup)
Iteration:  600 / 2000 [ 30%]  (Warmup)
Iteration:  600 / 2000 [ 30%]  (Warmup)
Iteration:  600 / 2000 [ 30%]  (Warmup)
Iteration:  600 / 2000 [ 30%]  (Warmup)
Iteration:  800 / 2000 [ 40%]  (Warmup)
Iteration:  800 / 2000 [ 40%]  (Warmup)
Iteration:  800 / 2000 [ 40%]  (Warmup)
Iteration:  800 / 2000 [ 40%]  (Warmup)
Iteration: 1000 / 2000 [ 50%]  (Warmup)
Iteration: 1001 / 2000 [ 50%]  (Sampling)
Iteration: 1000 / 2000 [ 50%]  (Warmup)
Iteration: 1001 / 2000 [ 50%]  (Sampling)
Iteration: 1000 / 2000 [ 50%]  (Warmup)
Iteration: 1001 / 2000 [ 50%]  (Sampling)
Iteration: 1000 / 2000 [ 50%]  (Warmup)
Iteration: 1001 / 2000 [ 50%]  (Sampling)
Iteration: 1200 / 2000 [ 60%]  (Sampling)
Iteration: 1200 / 2000 [ 60%]  (Sampling)
Iteration: 1200 / 2000 [ 60%]  (Sampling)
Iteration: 1200 / 2000 [ 60%]  (Sampling)
Iteration: 1400 / 2000 [ 70%]  (Sampling)
Iteration: 1400 / 2000 [ 70%]  (Sampling)
Iteration: 1400 / 2000 [ 70%]  (Sampling)
Iteration: 1400 / 2000 [ 70%]  (Sampling)
Iteration: 1600 / 2000 [ 80%]  (Sampling)
Iteration: 1600 / 2000 [ 80%]  (Sampling)
Iteration: 1600 / 2000 [ 80%]  (Sampling)
Iteration: 1600 / 2000 [ 80%]  (Sampling)
Iteration: 1800 / 2000 [ 90%]  (Sampling)
Iteration: 1800 / 2000 [ 90%]  (Sampling)
Iteration: 1800 / 2000 [ 90%]  (Sampling)
Iteration: 1800 / 2000 [ 90%]  (Sampling)
Iteration: 2000 / 2000 [100%]  (Sampling)

 Elapsed Time: 19.5348 seconds (Warm-up)
               17.1469 seconds (Sampling)
               36.6817 seconds (Total)

Iteration: 2000 / 2000 [100%]  (Sampling)

 Elapsed Time: 19.8768 seconds (Warm-up)
               16.8117 seconds (Sampling)
               36.6885 seconds (Total)

Iteration: 2000 / 2000 [100%]  (Sampling)

 Elapsed Time: 21.2892 seconds (Warm-up)
               16.3886 seconds (Sampling)
               37.6777 seconds (Total)

Iteration: 2000 / 2000 [100%]  (Sampling)

 Elapsed Time: 19.5799 seconds (Warm-up)
               17.5401 seconds (Sampling)
               37.12 seconds (Total)
#+end_example

#+begin_src R
summary(smod)
#+end_src

#+RESULTS:
#+begin_example

Model Info:

 function:     stan_glm
 family:       gaussian [identity]
 formula:      log(AvgCdia) ~ DBH
 algorithm:    sampling
 priors:       see help('prior_summary')
 sample:       4000 (posterior sample size)
 observations: 14440
 predictors:   2

Estimates:
                mean    sd      2.5%    25%     50%     75%     97.5%
(Intercept)       1.2     0.0     1.2     1.2     1.2     1.2     1.2
DBH               0.0     0.0     0.0     0.0     0.0     0.0     0.0
sigma             0.4     0.0     0.4     0.4     0.4     0.5     0.5
mean_PPD          2.0     0.0     2.0     2.0     2.0     2.0     2.1
log-posterior -8910.8     1.2 -8914.0 -8911.4 -8910.5 -8909.9 -8909.4

Diagnostics:
              mcse Rhat n_eff
(Intercept)   0.0  1.0  3986
DBH           0.0  1.0  4000
sigma         0.0  1.0  2642
mean_PPD      0.0  1.0  3693
log-posterior 0.0  1.0  1848

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).
#+end_example

#+begin_src R
print(smod, digits = 5)
#+end_src

#+RESULTS:


#+begin_src R
smod_Sp <- stan_glmer(log(AvgCdia) ~ DBH | SpCode, data = d, family = gaussian(link = "identity"))
#+end_src

#+RESULTS:
: Error: Using '|' in model formula not allowed. Maybe you meant to use 'stan_(g)lmer'?

posterior predict with exp transform

* COMMENT scratch
|                               |                |
|-------------------------------+----------------|
| Region                        | GulfCo         |
| Scientific.Name               | Butia capitata |
| SpCode                        | BUCA           |
| Independent.variable          | dbh            |
| Predicts.component            | crown dia      |
| Units.of.predicted.components | meters         |
| Model.weight                  | 1/ht^2         |
| EqName                        | cub            |
| a                             | -0.0575        |
| b                             | 0.10884        |
| c                             | 1.87801        |
| d                             | -0.45639       |
| e                             |                |
| Apps.min                      | 0.12           |
| Apps.max                      | 4.63           |
| Sigma                         |                |
| n                             |                |
| adj.R2                        |                |
| Data.min..from.raw.data.      | 0.7            |
| Data.max..from.raw.data.      | 7.4            |
| DF                            |                |



#+begin_src R
x <- 1:100
a <- seq(-.2, -1, -.2)
b <- seq(1.2,2, .2)
dq <- expand.grid(x = x, a = a,b = b)
dq <- mutate(dq, y = a*(x^2)/100 + b * x)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/understand_quad.png
  ggplot(dq, aes(x = x, y = y)) +
    geom_line() +
    facet_grid(a~ b)
#+end_src

#+RESULTS:
[[file:../figs/understand_quad.png]]

* Issues
1) Inconsistent naming of regions.  Is sacramento in the sacramento valley or the inland valley?
2) SpCode: "lain" instead of "LAIN"; "list" instead of "LIST"

* junk
 +
geom_vline(xintercept = -coef(m)[1]/(2*coef(m)[2]), linetype = "dashed", color = "blue")
